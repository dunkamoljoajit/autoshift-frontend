<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>สถิติการทำงาน - AutoNurseShift</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="lib/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="lib/flatpickr.css">
    <link rel="stylesheet" href="./lib/tailwind.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="components.js"></script> 
    
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #1e293b;
        }
        /* ระยะห่าง Header และ Navbar */
        .main-container { padding-top: 85px; padding-bottom: 100px; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1.5rem;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .weekly-detail-row { background-color: rgba(248, 250, 252, 0.6); animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body>
    <app-header class="fixed top-0 left-0 w-full z-50"></app-header> 

    <main class="main-container w-full max-w-7xl mx-auto px-4">
        
        <div class="glass-card p-6 shadow-xl mb-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex items-center gap-4">
                    <div class="bg-indigo-600 p-3 rounded-2xl shadow-lg shadow-indigo-200">
                        <i class="fas fa-chart-line text-white text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">สถิติการทำงาน</h2>
                        <p class="text-xs text-slate-500 font-medium italic">ข้อมูลสรุปรายปีและรายเดือน</p>
                    </div>
                </div>
                
                <div class="flex flex-row gap-3">
                    <div class="relative flex-1 min-w-[140px]">
                        <i class="fas fa-filter absolute left-4 top-1/2 -translate-y-1/2 text-indigo-500 text-xs z-10"></i>
                        <select id="monthSelector" class="w-full pl-12 pr-10 py-2.5 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none appearance-none h-11 cursor-pointer shadow-inner">
                            <option value="all">ทุกเดือน</option>
                            <option value="1">มกราคม</option>
                            <option value="2">กุมภาพันธ์</option>
                            <option value="3">มีนาคม</option>
                            <option value="4">เมษายน</option>
                            <option value="5">พฤษภาคม</option>
                            <option value="6">มิถุนายน</option>
                            <option value="7">กรกฎาคม</option>
                            <option value="8">สิงหาคม</option>
                            <option value="9">กันยายน</option>
                            <option value="10">ตุลาคม</option>
                            <option value="11">พฤศจิกายน</option>
                            <option value="12">ธันวาคม</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-[10px] text-slate-400"></i>
                    </div>

                    <div class="relative flex-1 min-w-[120px]">
                        <i class="fas fa-calendar-alt absolute left-4 top-1/2 -translate-y-1/2 text-indigo-500 text-xs z-10"></i>
                        <select id="yearSelector" class="w-full pl-12 pr-10 py-2.5 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-700 focus:outline-none appearance-none h-11 cursor-pointer shadow-inner">
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-[10px] text-slate-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-4 text-center">
            <div class="glass-card p-4 shadow-lg border-b-4 border-indigo-500">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">รวมเวร</p>
                <p class="text-3xl font-black text-indigo-600" id="totalShifts">0</p>
            </div>
            <div class="glass-card p-4 shadow-lg border-b-4 border-emerald-500">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">ชั่วโมง</p>
                <p class="text-3xl font-black text-emerald-500" id="totalHours">0</p>
            </div>
        </div>

        <div class="glass-card shadow-xl overflow-hidden mb-10">
            <div class="px-5 py-4 border-b border-slate-100 bg-white/50 flex justify-between items-center">
                <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                    <i class="fas fa-list text-indigo-500"></i> รายละเอียดรายเดือน
                </h3>
            </div>
            <div class="overflow-x-auto no-scrollbar">
                <table class="w-full text-sm text-left">
                    <thead class="text-[11px] text-slate-400 font-bold uppercase bg-slate-50/50">
                        <tr>
                            <th class="px-6 py-4">เดือน</th>
                            <th class="px-2 py-4 text-center">รวม</th>
                            <th class="px-2 py-4 text-center text-emerald-500">เช้า</th>
                            <th class="px-2 py-4 text-center text-orange-400">บ่าย</th>
                            <th class="px-2 py-4 text-center text-indigo-500">ดึก</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyShiftTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </main>

    <app-navbar class="fixed bottom-0 left-0 w-full z-50"></app-navbar>

    <script>
        const API_URL = (typeof API_BASE !== 'undefined') ? API_BASE : "https://autoshift-backend.onrender.com"; 
        const monthNamesFull = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
        const monthNamesShort = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
        let activeDetailRow = null;
        let fullYearDataCache = null;

        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            if (!userStr || !token) { window.location.href = 'login.html'; return; }

            const yearSelector = document.getElementById('yearSelector');
            const currentYearTH = new Date().getFullYear() + 543;
            let optionsHTML = '';
            for (let i = 0; i < 5; i++) {
                const yTH = currentYearTH - i;
                optionsHTML += `<option value="${yTH}">ปี ${yTH}</option>`;
            }
            yearSelector.innerHTML = optionsHTML;

            fetchData();
            yearSelector.addEventListener('change', fetchData);
            document.getElementById('monthSelector').addEventListener('change', filterAndRender);
        });

        async function fetchData() {
            const yearTH = document.getElementById('yearSelector').value;
            const yearAD = parseInt(yearTH) - 543;
            const tbody = document.getElementById('monthlyShiftTableBody');
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10"><i class="fas fa-circle-notch fa-spin text-indigo-400 text-lg"></i></td></tr>`;

            try {
                const user = JSON.parse(localStorage.getItem('user'));
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/my-stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ userId: user.UserID, year: yearAD })
                });

                if (response.status === 401) { localStorage.clear(); window.location.href = 'login.html'; return; }
                const result = await response.json();

                if (result.success) {
                    fullYearDataCache = result.data;
                    filterAndRender();
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-red-400">ไม่สามารถเชื่อมต่อฐานข้อมูลได้</td></tr>`;
            }
        }

        function filterAndRender() {
            if (!fullYearDataCache) return;
            const selectedMonth = document.getElementById('monthSelector').value;
            let displayList = (selectedMonth === "all") 
                ? fullYearDataCache.monthlyDetails 
                : fullYearDataCache.monthlyDetails.filter(m => m.month === parseInt(selectedMonth));

            updateCards(selectedMonth === "all" ? fullYearDataCache : displayList[0]);
            renderTable(displayList);
        }

        function updateCards(data) {
            if (!data) return;
            document.getElementById('totalShifts').textContent = (data.totalShifts || data.total || 0).toLocaleString();
            document.getElementById('totalHours').textContent = (data.totalHours || (data.total * 8) || 0).toLocaleString();
            document.getElementById('totalLeaves').textContent = (data.totalLeaves || 0).toLocaleString();
        }

        function renderTable(details) {
            const tbody = document.getElementById('monthlyShiftTableBody');
            tbody.innerHTML = '';
            if (!details || details.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-300 font-bold">ไม่มีข้อมูล</td></tr>`;
                return;
            }
            details.forEach((item) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-indigo-50/30 cursor-pointer border-b border-slate-50 transition-all";
                row.onclick = () => toggleDetails(row, item);
                row.innerHTML = `
                    <td class="px-6 py-4 font-bold text-slate-700">${monthNamesShort[item.month - 1]}</td>
                    <td class="px-2 py-4 text-center"><span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full font-black">${item.total}</span></td>
                    <td class="px-2 py-4 text-center text-emerald-600 font-semibold">${item.morning}</td>
                    <td class="px-2 py-4 text-center text-orange-600 font-semibold">${item.afternoon}</td>
                    <td class="px-2 py-4 text-center text-indigo-600 font-semibold">${item.night}</td>`;
                tbody.appendChild(row);
            });
        }

        function toggleDetails(row, data) {
            const yearAD = parseInt(document.getElementById('yearSelector').value) - 543;
            if (activeDetailRow && activeDetailRow.previousElementSibling === row) {
                activeDetailRow.remove(); activeDetailRow = null; return;
            }
            if (activeDetailRow) activeDetailRow.remove();

            const detailRow = document.createElement('tr');
            detailRow.className = 'weekly-detail-row';
            const weeks = calculateWeeks(yearAD, data);
            
            detailRow.innerHTML = `<td colspan="5" class="p-2">
                <div class="bg-white rounded-xl shadow-inner border border-indigo-100 p-3 mx-2 my-1 text-[11px]">
                    <table class="w-full">
                        <thead><tr class="text-slate-400 border-b border-slate-50"><th class="text-left py-1">สัปดาห์</th><th class="text-center py-1">รวม</th><th class="text-center py-1">ช</th><th class="text-center py-1">บ</th><th class="text-center py-1">ด</th></tr></thead>
                        <tbody class="divide-y divide-slate-50">${weeks.map(w => `<tr><td class="py-2">สัปดาห์ ${w.week}</td><td class="text-center font-bold">${w.total}</td><td class="text-center">${w.m}</td><td class="text-center">${w.a}</td><td class="text-center">${w.n}</td></tr>`).join('')}</tbody>
                    </table>
                </div>
            </td>`;
            row.after(detailRow);
            activeDetailRow = detailRow;
        }

        function calculateWeeks(year, data) {
            const first = new Date(year, data.month - 1, 1);
            const last = new Date(year, data.month, 0);
            const count = Math.ceil((first.getDay() + last.getDate()) / 7);
            const dist = (val) => {
                let a = new Array(count).fill(Math.floor(val/count));
                for(let i=0; i<val%count; i++) a[i]++; return a;
            };
            const m=dist(data.morning), a=dist(data.afternoon), n=dist(data.night);
            return Array.from({length:count}, (_,i)=>({week:i+1, m:m[i], a:a[i], n:n[i], total:m[i]+a[i]+n[i]}));
        }
    </script>
</body>
</html>