<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏•‡∏≤‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ß‡∏£ - AutoNurseShift</title>
    
    <link href="./style.css" rel="stylesheet">

    <link rel="stylesheet" href="./lib/flatpickr.css">
    <script src="./lib/flatpickr.js"></script>
    <script src="./lib/th.js"></script>

    <link rel="stylesheet" href="./lib/fontawesome/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="components.js"></script> 
    
    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f0f4f8;
            background-image: url('background06.png'); 
            background-size: cover; 
            background-position: center;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent; 
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Animation */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeUp 0.4s ease-out forwards; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Card Hover */
        .hover-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1); }
        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>

<body class="flex flex-col h-screen relative text-slate-800 overflow-hidden">

    <app-header class="sticky top-0 z-30 shadow-sm bg-white/90 backdrop-blur-md border-b border-slate-200"></app-header>
    
    <main class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6 lg:p-8 pb-28 md:pb-10 max-w-7xl mx-auto w-full">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 animate-enter">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-800 tracking-tight">‡∏ï‡∏•‡∏≤‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ß‡∏£</h1>
                <p class="text-slate-500 text-sm md:text-base mt-1">‡∏ã‡∏∑‡πâ‡∏≠-‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ß‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </div>
            
            <div class="flex items-center gap-3 w-full md:w-auto">
                <button onclick="reloadData()" class="w-10 h-10 md:w-auto md:px-4 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 shadow-sm flex items-center justify-center transition-all">
                    <i class="fas fa-sync-alt"></i> <span class="hidden md:inline ml-2 text-sm font-medium">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
                </button>
                <button onclick="openPostModal()" class="flex-1 md:flex-none bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-indigo-200 transition-all transform active:scale-95 flex items-center justify-center gap-2 text-sm font-medium">
                    <i class="fas fa-plus"></i> ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢
                </button>
            </div>
        </div>

        <div id="incomingRequestsSection" class="hidden mb-8 animate-enter" style="animation-delay: 0.1s;">
            <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 md:p-5 shadow-sm">
                <h2 class="text-base md:text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <span class="flex h-3 w-3 relative">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-amber-500"></span>
                    </span>
                    ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                </h2>
                <div id="incomingList" class="space-y-3"></div>
            </div>
        </div>

        <div class="mb-8 animate-enter" style="animation-delay: 0.15s;">
            <h2 class="text-base md:text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                <i class="fas fa-history text-indigo-500"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠ (Transaction)
            </h2>
            <div id="myStatusContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="col-span-full py-8 text-center text-slate-400 bg-white/60 rounded-xl border border-dashed border-slate-300">
                    <i class="fas fa-spinner fa-spin mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                </div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 sticky top-0 z-20 md:static py-2 md:py-0 animate-enter" style="animation-delay: 0.2s;">
            
            <div class="bg-slate-200/80 p-1 rounded-xl flex w-full md:w-auto backdrop-blur-md">
                <button onclick="switchTab('market')" id="tab-market" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white text-indigo-600 shadow-sm">
                    <i class="fas fa-store mr-2"></i> ‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á
                </button>
                <button onclick="switchTab('my-posts')" id="tab-myposts" class="flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-100">
                    <i class="fas fa-bullhorn mr-2"></i> ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </button>
            </div>

            <div id="filterSection" class="w-full md:w-auto overflow-x-auto pb-1 md:pb-0 no-scrollbar">
                <div class="flex gap-2 min-w-max">
                    <button onclick="filterShifts('all')" class="filter-btn active px-4 py-2 rounded-lg bg-slate-800 text-white text-xs font-medium shadow-md whitespace-nowrap transition-all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button onclick="filterShifts('morning')" class="filter-btn px-4 py-2 rounded-lg bg-white text-slate-600 border border-slate-200 text-xs font-medium hover:text-indigo-600 hover:border-indigo-300 whitespace-nowrap transition-all">üåû ‡πÄ‡∏ä‡πâ‡∏≤</button>
                    <button onclick="filterShifts('afternoon')" class="filter-btn px-4 py-2 rounded-lg bg-white text-slate-600 border border-slate-200 text-xs font-medium hover:text-indigo-600 hover:border-indigo-300 whitespace-nowrap transition-all">‚õÖ ‡∏ö‡πà‡∏≤‡∏¢</button>
                    <button onclick="filterShifts('night')" class="filter-btn px-4 py-2 rounded-lg bg-white text-slate-600 border border-slate-200 text-xs font-medium hover:text-indigo-600 hover:border-indigo-300 whitespace-nowrap transition-all">üåô ‡∏î‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>

        <div id="marketContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 pb-20 animate-enter" style="animation-delay: 0.25s;">
            </div>

    </main>

    <app-navbar class="sticky top-0 z-30 shadow-sm bg-white/90 backdrop-blur-md border-b border-slate-200"></app-navbar>

    <div id="postModalOverlay" class="fixed inset-0 bg-slate-900/60 z-[60] hidden backdrop-blur-sm transition-opacity opacity-0 duration-300"></div>
    <div id="postModal" class="fixed bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-[480px] md:-translate-x-1/2 md:-translate-y-1/2 bg-white z-[70] rounded-t-[2rem] md:rounded-2xl shadow-2xl transform translate-y-full md:translate-y-[20%] transition-transform duration-300 ease-out flex flex-col max-h-[90vh] hidden">
        
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-[2rem] md:rounded-t-2xl sticky top-0 z-10">
            <div>
                <div class="w-12 h-1.5 bg-slate-200 rounded-full mb-4 md:hidden mx-auto"></div>
                <h3 class="text-xl font-bold text-slate-800">‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ß‡∏£</h3>
            </div>
            <button onclick="closePostModal()" class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-6 overflow-y-auto custom-scrollbar">
            <form id="postShiftForm" onsubmit="submitPost(event)" class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1.5">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</label>
                    <div class="relative">
                        <select name="scheduleId" id="shiftSelector" class="w-full pl-10 pr-10 py-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-indigo-500 text-slate-800 appearance-none text-sm outline-none transition-all" required>
                            <option value="" disabled selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>
                        </select>
                        <i class="far fa-calendar-check absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <i class="fas fa-chevron-down absolute right-3.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1.5">‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</label>
                    <div class="relative">
                         <input type="text" name="condition" class="w-full pl-10 pr-4 py-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-indigo-500 text-slate-800 outline-none transition-all" placeholder="‡πÄ‡∏ä‡πà‡∏ô 500 ‡∏ö‡∏≤‡∏ó" required>
                         <i class="fas fa-tag absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1.5">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                    <textarea name="message" rows="3" class="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-indigo-500 text-slate-800 text-sm outline-none transition-all resize-none" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ..."></textarea>
                </div>

                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold mt-4 shadow-lg shadow-slate-300 hover:bg-slate-800 active:scale-[0.98] transition-all flex justify-center items-center gap-2">
                    <i class="fas fa-paper-plane text-sm"></i> ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
                </button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentUserId = null;
        let currentTab = 'market';

        document.addEventListener('DOMContentLoaded', () => {
            moment.locale('th'); // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            const userStr = localStorage.getItem('user');
            const token = localStorage.getItem('token');

            if (!userStr || !token) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                window.location.href = 'login.html'; 
                return;
            }

            currentUser = JSON.parse(userStr);
            currentUserId = currentUser.UserID; 

            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà ---
            const urlParams = new URLSearchParams(window.location.search);
            const targetTab = urlParams.get('tab');

            if (targetTab === 'my-posts') {
                switchTab('my-posts');
            } else {
                reloadData();
            }
            // -----------------------
        });

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
        function safeTimeAgo(dateInput) {
            const date = moment(dateInput);
            const now = moment();
            if (date.isAfter(now) || now.diff(date, 'seconds') < 60) { 
                return "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà"; 
            }
            return date.fromNow();
        }

        function reloadData() {
            fetchMarketData();
            fetchMyStatus();
            checkIncomingRequests();
        }

        function switchTab(tab) {
            currentTab = tab;
            const tabMarket = document.getElementById('tab-market');
            const tabMyPosts = document.getElementById('tab-myposts');
            const filterSection = document.getElementById('filterSection');

            const activeClass = "flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white text-indigo-600 shadow-sm";
            const inactiveClass = "flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-100";

            if (tab === 'market') {
                tabMarket.className = activeClass;
                tabMyPosts.className = inactiveClass;
                filterSection.classList.remove('hidden');
                fetchMarketData();
            } else {
                tabMyPosts.className = activeClass;
                tabMarket.className = inactiveClass;
                filterSection.classList.add('hidden');
                fetchMyActivePosts();
            }
        }

        async function fetchMarketData(filterType = 'all') {
            const token = localStorage.getItem('token');
            if(currentTab === 'market'){
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.className = 'filter-btn px-4 py-2 rounded-lg bg-white text-slate-600 border border-slate-200 text-xs font-medium hover:text-indigo-600 hover:border-indigo-300 whitespace-nowrap transition-all';
                });
            }

            const container = document.getElementById('marketContainer');
            container.innerHTML = `<div class="col-span-full text-center py-12"><i class="fas fa-circle-notch fa-spin text-3xl text-indigo-300"></i><p class="mt-2 text-slate-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;
            
            try {
                const response = await fetch(`${API_BASE}/api/market/shifts?type=${filterType}&userId=${currentUserId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if(response.status === 401) { window.location.href = 'login.html'; return; }

                const data = await response.json(); 
                container.innerHTML = ''; 

                if (data.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center py-12 flex flex-col items-center justify-center opacity-50"><i class="fas fa-store-slash text-4xl mb-3 text-slate-300"></i><span class="text-slate-400">‡∏ï‡∏•‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</span></div>`;
                    return;
                }

                data.forEach(shift => {
                    const badgeClass = shift.is_urgent ? 'bg-red-50 text-red-600 border-red-100' : 'bg-emerald-50 text-emerald-600 border-emerald-100';
                    const badgeIcon = shift.is_urgent ? 'fa-fire' : 'fa-check-circle';
                    const badgeText = shift.is_urgent ? '‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å' : '‡∏ß‡πà‡∏≤‡∏á';

                    const html = `
                    <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm hover-card transition-all-300 relative group cursor-pointer flex flex-col h-full animate-enter">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 font-bold border border-slate-200 text-sm">
                                    ${shift.user_name.charAt(0)}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm line-clamp-1">${shift.user_name}</div>
                                    <div class="text-xs text-slate-500">${shift.department}</div>
                                </div>
                            </div>
                            <span class="${badgeClass} border px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wide flex items-center gap-1">
                                <i class="fas ${badgeIcon}"></i> ${badgeText}
                            </span>
                        </div>
                        
                        <div class="bg-slate-50/80 rounded-xl p-3 mb-4 border border-slate-100 space-y-2">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 text-sm text-slate-700 font-medium">
                                    <i class="far fa-calendar text-indigo-500"></i> ${moment(shift.shift_date).format('D MMM YY')}
                                </div>
                                <div class="text-xs text-slate-400">${safeTimeAgo(shift.created_at)}</div> </div>
                            <div class="flex items-center gap-2 text-sm text-slate-700 font-medium">
                                <i class="far fa-clock text-orange-500"></i> ${shift.shift_time_label}
                            </div>
                        </div>

                        <div class="mt-auto pt-4 border-t border-slate-50 flex items-center justify-between gap-3">
                            <div class="text-indigo-600 font-bold text-sm bg-indigo-50 px-3 py-1.5 rounded-lg truncate max-w-[50%]">
                                ${shift.condition}
                            </div>
                            <button onclick="requestTrade(${shift.id}, '${shift.user_name}')" class="flex-1 bg-indigo-600 text-white hover:bg-indigo-700 px-4 py-2 rounded-lg text-xs font-bold transition-all shadow-md shadow-indigo-200 active:scale-95 whitespace-nowrap">
                                ‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            } catch (error) {
                console.error('API Error:', error);
                container.innerHTML = `<div class="col-span-full text-center text-red-400 py-10">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>`;
            }
        }

        async function fetchMyActivePosts() {
            const token = localStorage.getItem('token');
            const container = document.getElementById('marketContainer');
            container.innerHTML = `<div class="col-span-full text-center py-12"><i class="fas fa-circle-notch fa-spin text-3xl text-indigo-300"></i></div>`;

            try {
                const response = await fetch(`${API_BASE}/api/market/my-active-posts/${currentUserId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                container.innerHTML = '';

                if (data.posts.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center py-12 flex flex-col items-center justify-center opacity-50"><i class="fas fa-bullhorn text-4xl mb-3 text-slate-300"></i><span class="text-slate-400">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢</span></div>`;
                    return;
                }

                // ‚úÖ Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ schedule_id
                const formatted = data.posts.map(row => ({ 
                    id: row.id, 
                    schedule_id: row.schedule_id, // ‚úÖ ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å Backend ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß
                    price: row.price, 
                    message: row.message, 
                    shift_date: row.shift_date, 
                    shift_label: row.shift_label, 
                    created_at: row.created_at 
                }));

                formatted.forEach(post => {
                    const html = `
                    <div class="bg-white rounded-2xl p-5 border border-indigo-100 shadow-sm hover-card transition-all-300 relative group cursor-pointer flex flex-col h-full animate-enter ring-1 ring-indigo-50">
                        <div class="flex justify-between items-start mb-4">
                            <span class="bg-indigo-600 text-white px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wide">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
                            <small class="text-slate-400 text-xs">${safeTimeAgo(post.created_at)}</small> </div>

                        <div class="bg-slate-50 rounded-xl p-3 mb-4 border border-slate-100/50 space-y-2">
                             <div class="font-bold text-slate-800 text-sm flex items-center gap-2">
                                <i class="far fa-calendar text-indigo-500"></i> ${moment(post.shift_date).format('D MMM YYYY')}
                            </div>
                            <div class="text-sm text-slate-500 mt-1 flex items-center gap-2">
                                <i class="far fa-clock text-orange-500"></i> ${post.shift_label}
                            </div>
                        </div>

                         <div class="mb-4">
                            <div class="text-indigo-600 font-bold text-lg"><i class="fas fa-tag text-xs mr-1 opacity-50"></i> ${post.price}</div>
                            <div class="text-xs text-slate-400 truncate mt-1">${post.message || '-'}</div>
                        </div>

                        <div class="mt-auto pt-4 border-t border-slate-50 flex gap-2">
                            <button onclick="editPost(${post.id}, '${post.price}', '${post.message || ''}', ${post.schedule_id})" class="flex-1 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 px-3 py-2 rounded-lg text-xs font-bold transition-all">
                                <i class="fas fa-edit mr-1"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button onclick="deletePost(${post.id})" class="flex-1 bg-white border border-red-200 text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg text-xs font-bold transition-all">
                                <i class="fas fa-trash-alt mr-1"></i> ‡∏•‡∏ö
                            </button>
                        </div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="col-span-full text-center text-red-400">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>`;
            }
        }

        async function fetchMyStatus() {
            const token = localStorage.getItem('token');
            const container = document.getElementById('myStatusContainer');
            try {
                const response = await fetch(`${API_BASE}/api/market/my-requests/${currentUserId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                container.innerHTML = '';
                
                if (data.length === 0) {
                    container.innerHTML = `<div class="col-span-full py-8 text-center text-slate-400 bg-white/60 rounded-xl border border-dashed border-slate-300 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</div>`;
                    return;
                }
                
                data.forEach(item => {
                    let statusColor, statusText, statusIcon;

                    if (item.status === 'pending_seller') {
                        statusColor = 'bg-yellow-100 text-yellow-700 border border-yellow-200'; statusText = '‡∏£‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö'; statusIcon = 'fa-user-clock';
                    } else if (item.status === 'pending_headnurse') {
                        statusColor = 'bg-blue-100 text-blue-700 border border-blue-200'; statusText = '‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'; statusIcon = 'fa-user-nurse';
                    } else if (item.status === 'completed') {
                        statusColor = 'bg-green-100 text-green-700 border border-green-200'; statusText = '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; statusIcon = 'fa-check-circle';
                    } else if (item.status === 'rejected' || item.status === 'cancelled') {
                        statusColor = 'bg-red-100 text-red-700 border border-red-200'; statusText = '‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'; statusIcon = 'fa-times-circle';
                    } else {
                        statusColor = 'bg-slate-100 text-slate-700 border border-slate-200'; statusText = item.status; statusIcon = 'fa-info-circle';
                    }

                    const html = `
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm animate-enter hover:border-indigo-300 transition-colors relative overflow-hidden">
                         <div class="absolute left-0 top-0 bottom-0 w-1 ${statusColor.split(' ')[0]}"></div>
                        <div class="flex justify-between items-start mb-2 pl-2">
                            <span class="${statusColor} text-[10px] px-2 py-0.5 rounded-md font-bold uppercase tracking-wider flex items-center gap-1">
                                <i class="fas ${statusIcon}"></i> ${statusText}
                            </span>
                            <small class="text-slate-400 text-xs">${safeTimeAgo(item.created_at)}</small> </div>
                        <p class="font-bold text-slate-800 text-sm truncate pl-2">${item.title}</p> 
                        <div class="text-xs text-slate-500 mt-2 flex items-center gap-3 pl-2">
                            <span class="flex items-center gap-1"><i class="far fa-calendar-alt text-slate-400"></i> ${moment(item.shift_date).format('D MMM')}</span>
                            <span class="text-indigo-500 font-medium bg-indigo-50 px-2 py-0.5 rounded-md">${item.note || '-'}</span>
                        </div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="col-span-full text-center text-red-400 text-xs">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>`;
            }
        }

        async function checkIncomingRequests() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user')); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ RoleID

            try {
                // --- 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Pending_Seller) ---
                const res = await fetch(`${API_BASE}/api/market/incoming-requests/${currentUserId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                let allRequests = data.requests || [];

                // --- 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (RoleID 1) ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ (Pending_HeadNurse) ---
                if (user && user.RoleID === 1) {
                    const adminRes = await fetch(`${API_BASE}/api/admin/market/pending`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const adminData = await adminRes.json();
                    
                    // ‡∏ô‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å Admin ‡∏°‡∏≤‡∏£‡∏ß‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    if (adminData.success && adminData.results) {
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Flag ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á UI ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
                        const adminTasks = adminData.results.map(item => ({ ...item, isAdminTask: true }));
                        allRequests = [...allRequests, ...adminTasks];
                    }
                }

                const container = document.getElementById('incomingRequestsSection');
                const list = document.getElementById('incomingList');
                list.innerHTML = '';

                if (allRequests.length > 0) {
                    container.classList.remove('hidden'); 
                    
                    allRequests.forEach(req => {
                        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î UI ‡πÅ‡∏•‡∏∞ Action ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        const isFinalStep = req.isAdminTask === true;
                        const badgeColor = isFinalStep ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700';
                        const badgeText = isFinalStep ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢' : '‡πÄ‡∏™‡∏ô‡∏≠‡∏ã‡∏∑‡πâ‡∏≠';
                        const cardBorder = isFinalStep ? 'border-blue-300 shadow-md' : 'border-slate-100';
                        
                        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ä‡πâ adminAction, ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÉ‡∏ä‡πâ respondToRequest)
                        const actionFn = isFinalStep ? 'adminAction' : 'respondToRequest';
                        const approveText = isFinalStep ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢' : '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢';

                        const html = `
                        <div class="bg-white p-4 rounded-xl shadow-sm border ${cardBorder} flex flex-col md:flex-row justify-between items-center gap-4 transition-all hover:border-indigo-300 mb-3 animate-enter">
                            <div class="flex items-center gap-4 w-full">
                                <div class="w-12 h-12 min-w-[3rem] rounded-full ${isFinalStep ? 'bg-blue-50 text-blue-600' : 'bg-indigo-50 text-indigo-600'} flex items-center justify-center font-bold text-lg border border-opacity-50">
                                    <i class="fas ${isFinalStep ? 'fa-user-shield' : 'fa-shopping-cart'}"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex flex-wrap items-center gap-2 mb-1">
                                        <p class="text-sm font-bold text-slate-800 truncate">
                                            ${isFinalStep ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏Ñ‡∏∏‡∏ì ' + req.FirstName}
                                        </p>
                                        <span class="${badgeColor} text-[10px] px-2 py-0.5 rounded-full font-bold">${badgeText}</span>
                                    </div>
                                    <p class="text-xs text-slate-500">
                                        ${isFinalStep ? `<b>${req.SellerName}</b> ‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡πâ <b>${req.BuyerName}</b>` : `‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`}
                                        <span class="font-semibold text-slate-700">${moment(req.ShiftDate).format('D MMM')} (${req.ShiftName})</span>
                                    </p>
                                    <div class="mt-1.5 inline-block text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md">
                                        ‡∏£‡∏≤‡∏Ñ‡∏≤: ${req.Price}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 w-full md:w-auto pt-2 md:pt-0 border-t md:border-t-0 border-slate-50 mt-2 md:mt-0">
                                <button onclick="${actionFn}(${req.TransactionID}, 'reject')" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl border border-slate-200 text-slate-500 text-xs font-bold hover:bg-red-50 hover:text-red-500 transition-colors">
                                    ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                                </button>
                                <button onclick="${actionFn}(${req.TransactionID}, 'approve')" class="flex-1 md:flex-none px-5 py-2.5 rounded-xl bg-indigo-600 text-white text-xs font-bold hover:bg-indigo-700 shadow-md transition-all active:scale-95">
                                    ${approveText}
                                </button>
                            </div>
                        </div>`;
                        list.insertAdjacentHTML('beforeend', html);
                    });
                } else {
                    container.classList.add('hidden'); 
                }
            } catch (err) {
                console.error('Check incoming error:', err);
            }
        }

        function respondToRequest(transactionId, action) {
            const token = localStorage.getItem('token');
            Swal.fire({
                title: action === 'approve' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢?' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠?',
                text: action === 'approve' ? '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢' : '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
                icon: action === 'approve' ? 'info' : 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: action === 'approve' ? '#4f46e5' : '#ef4444',
                customClass: { popup: 'rounded-2xl' }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`${API_BASE}/api/market/seller-respond`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ transactionId, action })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({ icon: 'success', title: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', showConfirmButton: false, timer: 1500, customClass: { popup: 'rounded-2xl' } });
                            reloadData();
                        } else {
                            Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                        }
                    });
                }
            });
        }

        const overlay = document.getElementById('postModalOverlay');
        const modal = document.getElementById('postModal');

        function openPostModal() {
            overlay.classList.remove('hidden');
            modal.classList.remove('hidden');
            setTimeout(() => { 
                overlay.classList.remove('opacity-0');
                modal.classList.remove('translate-y-full', 'md:translate-y-[20%]'); 
                modal.classList.add('md:-translate-y-1/2'); 
            }, 10);
            loadMySellableShifts(); 
        }

        function closePostModal() {
            overlay.classList.add('opacity-0');
            modal.classList.remove('md:-translate-y-1/2'); 
            modal.classList.add('translate-y-full', 'md:translate-y-[20%]');
            setTimeout(() => { 
                overlay.classList.add('hidden'); 
                modal.classList.add('hidden');
            }, 300);
        }
        overlay.addEventListener('click', closePostModal);

        async function loadMySellableShifts() {
            const token = localStorage.getItem('token');
            const selector = document.getElementById('shiftSelector');
            selector.innerHTML = '<option value="" disabled selected>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ß‡∏£...</option>';

            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Backend ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢)
                const res = await fetch(`${API_BASE}/api/my-sellable-shifts/${currentUserId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if(res.status === 401) { window.location.href = 'login.html'; return; }
                const data = await res.json();

                if(data.success && data.shifts.length > 0) {
                    selector.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ --</option>';
                    
                    data.shifts.forEach(shift => {
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà Backend ‡∏™‡πà‡∏á‡∏°‡∏≤)
                        const isSelling = shift.SellingStatus === 'Open';
                        const isInTransaction = shift.TransactionStatus; // ‡πÄ‡∏ä‡πà‡∏ô Pending_Seller, Pending_HeadNurse
                        const isExchanging = shift.ExchangeStatus === 'pending';
                        
                        const isBusy = isSelling || isInTransaction || isExchanging;
                        
                        let statusNote = "";
                        if (isSelling) statusNote = " (‡∏•‡∏á‡∏Ç‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)";
                        else if (isInTransaction) statusNote = " (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢)";
                        else if (isExchanging) statusNote = " (‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà)";

                        const option = document.createElement('option');
                        option.value = shift.id;
                        // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà disabled ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                        if (isBusy) {
                            option.disabled = true;
                            option.style.color = '#94a3b8'; // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
                        }
                        option.textContent = `${shift.label}${statusNote}`;
                        selector.appendChild(option);
                    });
                } else {
                    selector.innerHTML = '<option value="" disabled selected>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</option>';
                }
            } catch (err) {
                selector.innerHTML = '<option value="" disabled selected>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>';
            }
        }
        async function submitPost(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const formData = new FormData(e.target);
            const selectedScheduleId = formData.get('scheduleId');
            
            if(!selectedScheduleId) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', 'warning');
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            btn.disabled = true;

            try {
                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Server ‡∏Å‡πà‡∏≠‡∏ô (Real-time Validation)
                const checkRes = await fetch(`${API_BASE}/api/swaps/check-status/${selectedScheduleId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const statusData = await checkRes.json();

                if (statusData.success && (statusData.isSelling || statusData.isPending || statusData.isInTransaction)) {
                    let msg = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏£‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà";
                    if (statusData.isSelling) msg = "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ß‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
                    if (statusData.isPending) msg = "‡πÄ‡∏ß‡∏£‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô";

                    Swal.fire({ icon: 'error', title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: msg, confirmButtonColor: '#4f46e5' });
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                // 2. ‡∏´‡∏≤‡∏Å‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                const payload = {
                    userId: currentUserId,
                    scheduleId: selectedScheduleId,
                    price: formData.get('condition'),
                    message: formData.get('message') || '' 
                };

                const res = await fetch(`${API_BASE}/api/sell-shift`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if(data.success) {
                    closePostModal();
                    Swal.fire({ icon: 'success', title: '‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', showConfirmButton: false, timer: 1500 });
                    e.target.reset();
                    switchTab('my-posts'); 
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            } catch (err) {
                Swal.fire('Error', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function deletePost(postId) {
            const token = localStorage.getItem('token');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
            if (!postId) {
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏û‡∏™‡∏ï‡πå', 'error');
                return;
            }

            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÑ‡∏î‡πâ",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                customClass: { popup: 'rounded-2xl' }
            }).then((result) => {
                if (result.isConfirmed) {
                    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á API
                    fetch(`${API_BASE}/api/market/delete-post`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            'Authorization': `Bearer ${token}` 
                        },
                        body: JSON.stringify({ postId: postId }) // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', showConfirmButton: false, timer: 1000 });
                            fetchMyActivePosts(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                        } else {
                            // ‡∏Å‡∏£‡∏ì‡∏µ Backend ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö 400 ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏à‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏¢‡∏π‡πà)
                            Swal.fire('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', data.message, 'warning');
                        }
                    })
                    .catch(err => {
                        console.error("Delete Error:", err);
                        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ', 'error');
                    });
                }
            });
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏£
        async function editPost(postId, oldPrice, oldMsg, currentScheduleId) {
            const token = localStorage.getItem('token');
            
            // ‡πÅ‡∏™‡∏î‡∏á Loading
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', didOpen: () => Swal.showLoading() });

            try {
                // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ (My Sellable Shifts)
                const res = await fetch(`${API_BASE}/api/my-sellable-shifts/${currentUserId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                let shiftOptionsHtml = '';
                
                if (data.success && data.shifts.length > 0) {
                    shiftOptionsHtml = data.shifts.map(shift => {
                        const isSelected = shift.id == currentScheduleId ? 'selected' : '';
                        return `<option value="${shift.id}" ${isSelected}>${shift.label}</option>`;
                    }).join('');
                }
                
                // ‡∏Å‡∏£‡∏ì‡∏µ API ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Open) ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                if(shiftOptionsHtml === '') {
                     shiftOptionsHtml = `<option value="${currentScheduleId}" selected>‡πÄ‡∏ß‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</option>`;
                }

                // ‡πÅ‡∏™‡∏î‡∏á Popup ‡∏û‡∏£‡πâ‡∏≠‡∏° Dropdown
                const { value: formValues } = await Swal.fire({
                    title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                    html:
                        `<div class="text-left space-y-3">` +
                            `<div>` +
                                `<label class="block text-sm mb-1 text-slate-600 font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ç‡∏≤‡∏¢</label>` +
                                `<select id="swal-schedule" class="swal2-input !m-0 !h-10 w-full text-sm">` +
                                    shiftOptionsHtml +
                                `</select>` +
                            `</div>` +

                            `<div>` +
                                `<label class="block text-sm mb-1 text-slate-600 font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</label>` +
                                `<input id="swal-price" class="swal2-input !m-0 !h-10 w-full" value="${oldPrice}">` +
                            `</div>` +

                            `<div>` +
                                `<label class="block text-sm mb-1 text-slate-600 font-bold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>` +
                                `<input id="swal-msg" class="swal2-input !m-0 !h-10 w-full" value="${oldMsg}">` +
                            `</div>` +
                        `</div>`,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    confirmButtonColor: '#4f46e5',
                    customClass: { popup: 'rounded-2xl' },
                    preConfirm: () => {
                        return {
                            scheduleId: document.getElementById('swal-schedule').value,
                            price: document.getElementById('swal-price').value,
                            message: document.getElementById('swal-msg').value
                        }
                    }
                });

                if (formValues) {
                    if (!formValues.scheduleId) {
                        Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£', 'warning');
                        return;
                    }

                    fetch(`${API_BASE}/api/market/edit-post`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ 
                            postId, 
                            userId: currentUserId, 
                            ...formValues 
                        }) 
                    })
                    .then(async response => {
                        const data = await response.json();
                        if (response.ok) {
                            Swal.fire({ title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', icon: 'success', timer: 1000, showConfirmButton: false });
                            fetchMyActivePosts(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                        } else {
                            Swal.fire('‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', data.message, 'warning');
                        }
                    })
                    .catch(err => Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ', 'error'));
                }

            } catch (err) {
                console.error(err);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏£‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function requestTrade(shiftId, sellerName) {
            const token = localStorage.getItem('token');
            Swal.fire({
                title: `‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏ß‡∏£‡∏à‡∏≤‡∏Å ${sellerName}?`,
                text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4f46e5',
                cancelButtonColor: '#94a3b8',
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                customClass: { popup: 'rounded-2xl' }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`${API_BASE}/api/market/request-trade`, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            buyerId: currentUserId,
                            postSellId: shiftId 
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({ icon: 'success', title: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏£‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', showConfirmButton: false, timer: 2000, customClass: { popup: 'rounded-2xl' } });
                            reloadData();
                        } else {
                            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', 'error');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        Swal.fire('Connection Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ', 'error');
                    });
                }
            });
        }

        function filterShifts(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.className = 'filter-btn px-4 py-2 rounded-lg bg-white text-slate-600 border border-slate-200 text-xs font-medium hover:text-indigo-600 hover:border-indigo-300 whitespace-nowrap transition-all';
            });
            event.target.className = 'filter-btn active px-4 py-2 rounded-lg bg-slate-800 text-white text-xs font-medium shadow-md whitespace-nowrap transition-all';
            
            fetchMarketData(type);
        }
                async function adminAction(transactionId, action) {
            const result = await Swal.fire({
                title: action === 'approve' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò?',
                text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ñ‡∏≤‡∏ß‡∏£",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: action === 'approve' ? '#10b981' : '#ef4444',
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                const token = localStorage.getItem('token');
                try {
                    const res = await fetch(`${API_BASE}/api/admin/market/action`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Authorization': `Bearer ${token}` 
                        },
                        body: JSON.stringify({ 
                            transactionId: transactionId, 
                            action: action, 
                            adminId: currentUserId 
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', data.message, 'success');
                        reloadData(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    }
                } catch (err) {
                    Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                }
            }
        }
        async function fetchAdminPendingActions() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (RoleID 1)
            const user = JSON.parse(localStorage.getItem('user'));
            if (user.RoleID !== 1) return; 

            const token = localStorage.getItem('token');
            const container = document.getElementById('marketContainer'); // ‡∏´‡∏£‡∏∑‡∏≠ ID ‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô

            try {
                const res = await fetch(`${API_BASE}/api/admin/market/pending`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.success && data.results.length > 0) {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà" ‡∏≠‡∏≠‡∏Å
                    const emptyState = document.querySelector('.no-items-message');
                    if (emptyState) emptyState.style.display = 'none';

                    data.results.forEach(item => {
                        const cardHtml = `
                        <div class="bg-white p-5 rounded-2xl border-2 border-indigo-100 shadow-sm mb-4 animate-enter">
                            <div class="flex justify-between items-start mb-3">
                                <span class="bg-amber-100 text-amber-700 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</span>
                                <small class="text-slate-400 text-xs">${moment(item.CreatedAt).fromNow()}</small>
                            </div>
                            <div class="space-y-2">
                                <p class="text-sm text-slate-700">
                                    <b>${item.SellerName}</b> ‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ß‡∏£‡πÉ‡∏´‡πâ <b>${item.BuyerName}</b>
                                </p>
                                <p class="text-xs text-slate-500">
                                    <i class="far fa-calendar-alt"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏£: ${moment(item.ShiftDate).format('D MMM YYYY')} (${item.ShiftName})
                                </p>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <button onclick="adminAction(${item.TransactionID}, 'reject')" class="flex-1 px-4 py-2 rounded-xl border border-red-200 text-red-500 text-xs font-bold hover:bg-red-50 transition-all">
                                    ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                                </button>
                                <button onclick="adminAction(${item.TransactionID}, 'approve')" class="flex-1 px-4 py-2 rounded-xl bg-indigo-600 text-white text-xs font-bold hover:bg-indigo-700 shadow-md transition-all active:scale-95">
                                    ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏ß‡∏£
                                </button>
                            </div>
                        </div>`;
                        container.insertAdjacentHTML('afterbegin', cardHtml);
                    });
                }
            } catch (err) {
                console.error("Fetch Admin Error:", err);
            }
        }
    </script>
</body>
</html>