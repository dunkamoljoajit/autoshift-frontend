<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• - AutoNurseShift</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="./lib/flatpickr.css">
    <script src="./lib/flatpickr.js"></script>
    <script src="./lib/th.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="components.js"></script> 

    <style>
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f8fafc;
            background-image: radial-gradient(circle at top right, #eef2ff 0%, transparent 40%),
                              radial-gradient(circle at bottom left, #f5f3ff 0%, transparent 40%);
            background-attachment: fixed;
        }

        /* Modern Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }

        /* Card Stylings */
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.08); }

        /* Bracket Cards with Glow */
        .bracket-card {
            position: relative;
            padding-left: 1.25rem;
            border-radius: 1.5rem;
            overflow: hidden;
            background: white;
            border: 1px solid #f1f5f9;
        }
        .bracket-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
        }
        .bracket-black::before { background: #1e293b; box-shadow: 2px 0 10px rgba(30, 41, 59, 0.2); }
        .bracket-purple::before { background: #8b5cf6; box-shadow: 2px 0 10px rgba(139, 92, 246, 0.2); }

        /* Animations */
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-enter { animation: fadeInScale 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>

<body class="flex flex-col h-screen overflow-hidden">

    <app-header class="fixed top-0 w-full z-50 bg-white/70 backdrop-blur-lg border-b border-slate-100"></app-header>

    <main class="flex-1 overflow-y-auto pt-24 pb-28 custom-scrollbar">
        <div class="max-w-6xl mx-auto px-4 md:px-6 grid grid-cols-1 lg:grid-cols-12 gap-8">

            <div class="lg:col-span-7 space-y-6">
                <div class="glass-card rounded-[2.5rem] p-6 md:p-8 relative overflow-hidden">
                    <div class="absolute -top-12 -right-12 w-48 h-48 bg-indigo-100 rounded-full blur-3xl opacity-50"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                                <i class="fas fa-magnifying-glass text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 tracking-tight">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£</h2>
                                <p class="text-slate-400 text-sm font-medium">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏ß‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                            </div>
                        </div>

                        <form id="searchForm" class="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div class="md:col-span-5">
                                <label class="text-[11px] font-bold text-slate-400 ml-2 mb-1.5 block uppercase tracking-widest">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
                                <div class="relative">
                                    <input type="text" id="searchDate" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..." 
                                           class="w-full bg-slate-50/50 border border-slate-200 rounded-2xl px-5 py-3.5 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all shadow-inner">
                                </div>
                            </div>
                            <div class="md:col-span-4">
                                <label class="text-[11px] font-bold text-slate-400 ml-2 mb-1.5 block uppercase tracking-widest">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                                <select id="searchShift" class="w-full bg-slate-50/50 border border-slate-200 rounded-2xl px-5 py-3.5 text-sm font-bold text-slate-700 focus:outline-none focus:border-indigo-500 appearance-none shadow-inner">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏Å‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</option>
                                    <option value="1">‚òÄÔ∏è ‡πÄ‡∏ß‡∏£‡πÄ‡∏ä‡πâ‡∏≤</option>
                                    <option value="2">üå§Ô∏è ‡πÄ‡∏ß‡∏£‡∏ö‡πà‡∏≤‡∏¢</option>
                                    <option value="3">üåô ‡πÄ‡∏ß‡∏£‡∏î‡∏∂‡∏Å</option>
                                </select>
                            </div>
                            <div class="md:col-span-3 flex items-end">
                                <button type="submit" id="search-btn" class="w-full bg-slate-900 hover:bg-black text-white font-bold h-[54px] rounded-2xl shadow-xl transition-all active:scale-95 flex items-center justify-center gap-2 group">
                                    <span id="search-btn-text">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
                                    <i class="fas fa-chevron-right text-[10px] group-hover:translate-x-1 transition-transform"></i>
                                    <i id="search-loading" class="fas fa-circle-notch fa-spin hidden"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="results-area" class="opacity-0 transition-all duration-700">
                    <div class="flex items-center justify-between mb-6 px-2">
                        <h3 class="font-bold text-slate-800 text-lg">
                            ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <span id="result-count" class="ml-2 text-xs font-black px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
                        </h3>
                    </div>
                    <div id="searchResults" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-full py-16 text-center">
                            <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-user-group text-2xl text-slate-300"></i>
                            </div>
                            <p class="text-slate-400 font-medium">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 space-y-6">
                <div class="glass-card rounded-[2.5rem] p-7">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white">
                                <i class="fas fa-bullhorn text-sm"></i>
                            </div>
                            <h3 class="font-bold text-slate-800 text-lg">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
                        </div>
                        <button onclick="openPostModal()" class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white transition-all active:scale-90 flex items-center justify-center shadow-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="my-posts-list" class="space-y-3 max-h-[320px] overflow-y-auto no-scrollbar pr-1">
                         <p class="text-center text-slate-300 py-10 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®...</p>
                    </div>
                </div>
                
                <div class="px-2">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                            <i class="fas fa-inbox text-indigo-500"></i> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£‡πÄ‡∏Ç‡πâ‡∏≤
                        </h3>
                        <span id="incoming-badge" class="hidden bg-rose-500 text-white text-[10px] px-2.5 py-1 rounded-full font-black animate-bounce shadow-lg shadow-rose-200">NEW</span>
                    </div>
                    <div id="incoming-list" class="space-y-4 max-h-[400px] overflow-y-auto no-scrollbar pr-1">
                        <p class="text-center text-slate-300 py-10 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</p>
                    </div>
                </div>

                <div id="head-nurse-approval-section" class="hidden pt-6 border-t border-slate-200">
                    <div class="flex items-center justify-between mb-4 px-2">
                        <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                            <i class="fas fa-shield-check text-purple-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        </h3>
                        <span id="approval-badge" class="bg-purple-600 text-white text-[10px] px-2.5 py-1 rounded-full font-black shadow-lg shadow-purple-200">0</span>
                    </div>
                    <div id="approval-list" class="space-y-4 max-h-[450px] overflow-y-auto no-scrollbar pr-1"></div>
                </div>
            </div>
        </div>
    </main>

    <app-navbar></app-navbar>

    <div id="postModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[60] flex items-center justify-center p-4 opacity-0 transition-all duration-300">
        <div class="bg-white rounded-[2.5rem] w-full max-w-md p-8 shadow-2xl transform scale-90 transition-all duration-300 relative overflow-hidden" id="postModalContent">
            <button onclick="closePostModal()" class="absolute top-6 right-6 w-10 h-10 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-slate-100 transition"><i class="fas fa-times"></i></button>
            
            <div class="flex items-center gap-4 mb-8">
                <div class="w-14 h-14 bg-rose-50 text-rose-500 rounded-2xl flex items-center justify-center text-2xl"><i class="fas fa-bullhorn"></i></div>
                <h3 class="text-2xl font-bold text-slate-800">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£</h3>
            </div>

            <form id="createPostForm" class="space-y-6">
                <div>
                    <label class="block text-[11px] font-bold text-slate-400 mb-2 uppercase tracking-widest ml-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ</label>
                    <div class="relative">
                        <input type="text" id="post-desired-date" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-rose-500/10 focus:border-rose-500 outline-none transition-all" placeholder="‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ / ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ">
                        <i class="far fa-calendar absolute right-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                    </div>
                </div>

                <div class="bg-rose-50/50 rounded-3xl p-5 border border-rose-100/50">
                    <label class="block text-[11px] font-bold text-rose-800 mb-3 uppercase tracking-widest ml-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢</label>
                    <div class="relative">
                        <select id="post-my-shift" class="w-full bg-white border border-rose-200 rounded-2xl p-4 text-sm font-bold text-slate-700 focus:outline-none focus:ring-4 focus:ring-rose-500/10 appearance-none transition-all cursor-pointer shadow-sm" required>
                            <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏£...</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-rose-300 text-xs pointer-events-none"></i>
                    </div>
                </div>

                <div>
                    <label class="block text-[11px] font-bold text-slate-400 mb-2 uppercase tracking-widest ml-2">‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="post-note" rows="2" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-sm font-medium resize-none focus:ring-2 focus:ring-rose-500/10 outline-none transition-all" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏¥‡∏î‡∏ò‡∏∏‡∏£‡∏∞‡∏î‡πà‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞..."></textarea>
                </div>

                <button type="submit" id="btn-create-post" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-2xl shadow-xl shadow-slate-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-paper-plane"></i> ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô
                </button>
            </form>
        </div>
    </div>

    <div id="requestModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[60] flex items-center justify-center p-4 opacity-0 transition-all duration-300">
        <div class="bg-white rounded-[2.5rem] w-full max-w-md p-8 shadow-2xl transform scale-90 transition-all duration-300" id="requestModalContent">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner border border-white">
                    <i class="fas fa-shuffle"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£</h3>
                <div class="inline-block mt-2 px-4 py-1.5 bg-indigo-50 text-indigo-600 rounded-full text-xs font-black">‡πÅ‡∏•‡∏Å‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì: <span id="modal-target-name">...</span></div>
            </div>

            <form id="sendRequestForm" class="space-y-6">
                <input type="hidden" id="modal-target-user-id">
                <input type="hidden" id="modal-target-schedule-id">
                
                <div class="bg-indigo-50/50 rounded-3xl p-6 border border-indigo-100">
                    <label class="block text-[11px] font-bold text-indigo-400 mb-3 uppercase tracking-widest">‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏•‡∏Å</label>
                    <div class="relative">
                        <select id="my-offer-shift" class="w-full bg-white border border-indigo-200 rounded-2xl p-4 text-sm font-bold text-slate-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 appearance-none shadow-sm" required>
                            <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏é‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢...</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-indigo-300 text-xs"></i>
                    </div>
                </div>

                <textarea id="modal-reason" rows="2" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-sm font-medium resize-none outline-none focus:ring-2 focus:ring-indigo-500/10" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>

                <div class="flex gap-3">
                    <button type="button" onclick="closeRequestModal()" class="flex-1 py-4 text-slate-400 font-bold hover:text-slate-600 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" id="submit-request-btn" class="flex-[2] bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-xl shadow-indigo-100 transition-all active:scale-95">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editPostModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[60] flex items-center justify-center p-4 opacity-0 transition-all duration-300">
        <div class="bg-white rounded-[2.5rem] w-full max-w-md p-8 shadow-2xl transform scale-90 transition-all duration-300" id="editPostModalContent">
            <h3 class="text-2xl font-bold text-slate-800 mb-8 flex items-center gap-3">
                <div class="w-12 h-12 bg-amber-50 text-amber-500 rounded-2xl flex items-center justify-center"><i class="fas fa-pen-to-square"></i></div>
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
            </h3>
            <form id="editPostForm" class="space-y-6">
                <input type="hidden" id="edit-post-id">
                <div>
                    <label class="block text-[11px] font-bold text-slate-400 mb-2 uppercase tracking-widest ml-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ</label>
                    <div class="relative">
                        <input type="text" id="edit-desired-date" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-sm font-bold outline-none" placeholder="‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ / ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ">
                        <button type="button" onclick="clearEditDate()" class="absolute right-4 top-1/2 -translate-y-1/2 text-[10px] font-bold text-rose-500 hover:underline">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    </div>
                </div>
                <div class="bg-slate-50 rounded-3xl p-5 border border-slate-200/50">
                    <label class="block text-[11px] font-bold text-slate-400 mb-3 uppercase tracking-widest ml-1">‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏Å</label>
                    <select id="edit-post-schedule-id" class="w-full bg-white border border-slate-200 rounded-2xl p-4 text-sm font-bold text-slate-700 outline-none"></select>
                </div>
                <textarea id="edit-post-note" rows="2" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-sm outline-none" placeholder="‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                <div class="flex gap-3">
                    <button type="button" onclick="closeEditPostModal()" class="flex-1 py-4 text-slate-400 font-bold">‡∏õ‡∏¥‡∏î</button>
                    <button type="submit" id="btn-update-post" class="flex-[2] bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl active:scale-95 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    let currentUser = null;

    // Window bindings
    window.openPostModal = openPostModal;
    window.closePostModal = closePostModal;
    window.handleSearch = handleSearch;
    window.openRequestModal = openRequestModal;
    window.closeRequestModal = closeRequestModal;
    window.handleSendRequest = handleSendRequest;
    window.handleCreatePost = handleCreatePost;
    window.openEditPostModal = openEditPostModal;
    window.closeEditPostModal = closeEditPostModal;
    window.handleUpdatePost = handleUpdatePost;
    window.clearEditDate = clearEditDate;
    window.deletePost = deletePost;
    window.respondSwap = respondSwap;
    window.respondApproval = respondApproval;
    window.fetchPendingApprovals = fetchPendingApprovals;

    document.addEventListener('DOMContentLoaded', () => {
        const userStr = localStorage.getItem('user');
        const token = localStorage.getItem('token');

        if(!userStr || !token) { window.location.href = 'login.html'; return; }
        currentUser = JSON.parse(userStr);
        
        if (currentUser.RoleID === 1) {
            document.body.style.backgroundImage = "url('background01.png')"; 
            const approvalSection = document.getElementById('head-nurse-approval-section');
            if (approvalSection) {
                approvalSection.classList.remove('hidden');
                fetchPendingApprovals();
            }
        } else {
            document.body.style.backgroundImage = "url('background06.png')";
        }

        flatpickr("#searchDate", { locale: "th", dateFormat: "Y-m-d", altInput: true, altFormat: "j F Y", disableMobile: "true" });
        flatpickr("#post-desired-date", { locale: "th", dateFormat: "Y-m-d", altInput: true, altFormat: "j F Y", disableMobile: "true" });
        flatpickr("#edit-desired-date", { locale: "th", dateFormat: "Y-m-d", altInput: true, altFormat: "j F Y", disableMobile: "true" });

        setTimeout(() => document.getElementById('results-area').classList.remove('opacity-0'), 300);
        
        fetchIncomingRequests();
        fetchMyActivePost(); 

        document.getElementById('searchForm').addEventListener('submit', window.handleSearch);
        document.getElementById('sendRequestForm').addEventListener('submit', window.handleSendRequest);
        document.getElementById('createPostForm').addEventListener('submit', window.handleCreatePost);
        document.getElementById('editPostForm').addEventListener('submit', window.handleUpdatePost);
    });

    async function handleSearch(e) {
        e.preventDefault();
        const date = document.getElementById('searchDate').value; 
        const shiftId = document.getElementById('searchShift').value;
        const container = document.getElementById('searchResults');
        const token = localStorage.getItem('token');
        
        if(!date) return Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' });

        document.getElementById('search-btn-text').classList.add('hidden');
        document.getElementById('search-loading').classList.remove('hidden');
        container.innerHTML = `<div class="col-span-full py-20 text-center animate-pulse"><div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-4"></div><div class="text-slate-400 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô...</div></div>`;

        try {
            const myShiftsRes = await fetch(`${API_BASE}/api/schedule/my-future-shifts/${currentUser.UserID}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const myShiftsData = await myShiftsRes.json();
            const myBusyDates = myShiftsData.success ? myShiftsData.results.map(s => moment(s.Nurse_Date).format('YYYY-MM-DD')) : [];

            const response = await fetch(`${API_BASE}/api/swaps/search`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ date, shiftId, requesterId: currentUser.UserID })
            });

            const data = await response.json();
            container.innerHTML = '';

            if(data.success && data.results.length > 0) {
                if (myBusyDates.includes(date)) {
                    document.getElementById('result-count').innerText = "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ";
                    container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-12 glass-card rounded-[2rem] border-rose-100 bg-rose-50/50"><p class="text-rose-600 font-bold">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ</p></div>`;
                    return;
                }
                document.getElementById('result-count').innerText = `‡∏û‡∏ö ${data.results.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                container.innerHTML = data.results.map((item, i) => {
                    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    let profileSrc = (item.ProfileImage && item.ProfileImage.startsWith('http')) 
                        ? item.ProfileImage 
                        : `https://ui-avatars.com/api/?name=${encodeURIComponent(item.FirstName)}&background=6366f1&color=fff&size=128`;
                    
                    return `
                    <div class="glass-card rounded-3xl p-5 border border-white animate-enter flex flex-col gap-4 shadow-sm" style="animation-delay:${i*0.05}s">
                        <div class="flex items-center gap-4">
                            <img src="${profileSrc}" class="w-14 h-14 rounded-2xl object-cover ring-4 ring-slate-50 shadow-sm">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-slate-800 truncate text-sm">${item.FirstName} ${item.LastName}</h4>
                                <div class="inline-block mt-1 px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-[10px] font-black uppercase tracking-wider">${item.ShiftName}</div>
                            </div>
                        </div>
                        <button onclick="window.openRequestModal('${item.UserID}', '${item.FirstName}', '${item.ScheduleID}')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black py-3.5 rounded-2xl shadow-lg shadow-indigo-100 transition-all flex items-center justify-center gap-2">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£ <i class="fas fa-paper-plane text-[10px]"></i></button>
                    </div>`;
                }).join('');
            } else {
                document.getElementById('result-count').innerText = "0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
                container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 opacity-50"><div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4"><i class="fas fa-ghost text-2xl text-slate-300"></i></div><p class="text-slate-400 font-bold font-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</p></div>`;
            }
        } catch (err) { container.innerHTML = `<div class="col-span-full text-center text-rose-500 py-10 font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢</div>`; }
        finally {
            document.getElementById('search-btn-text').classList.remove('hidden');
            document.getElementById('search-loading').classList.add('hidden');
        }
    }

    async function handleSendRequest(e) {
        e.preventDefault();
        const myScheduleId = document.getElementById('my-offer-shift').value;
        if(!myScheduleId) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', '', 'warning');
        const token = localStorage.getItem('token');
        const btn = document.getElementById('submit-request-btn');
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...';
        
        try {
            const res = await fetch(`${API_BASE}/api/swaps/send-request`, {
                method: 'POST',
                headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${token}`},
                body: JSON.stringify({
                    requesterId: currentUser.UserID,
                    targetScheduleId: document.getElementById('modal-target-schedule-id').value,
                    requesterScheduleId: myScheduleId,
                    reason: document.getElementById('modal-reason').value
                })
            });
            const data = await res.json();
            if(data.success) { 
                window.closeRequestModal(); 
                Swal.fire({icon:'success', title:'‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text:'‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', customClass:{popup:'rounded-[2rem]'}}); 
                fetchIncomingRequests(); 
            } else { Swal.fire('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', data.message, 'error'); }
        } catch(err) { Swal.fire('Error', '‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á', 'error'); }
        finally { btn.disabled = false; btn.innerHTML = originalText; }
    }

    async function openPostModal() {
        const token = localStorage.getItem('token');
        document.getElementById('createPostForm').reset();
        const select = document.getElementById('post-my-shift');
        select.innerHTML = '<option value="" disabled selected>üîÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</option>';
        
        document.getElementById('postModal').classList.remove('hidden');
        setTimeout(() => document.getElementById('postModal').classList.add('opacity-100'), 10);
        document.getElementById('postModalContent').classList.replace('scale-90', 'scale-100');

        try {
            const res = await fetch(`${API_BASE}/api/schedule/my-future-shifts/${currentUser.UserID}`, { headers: {'Authorization': `Bearer ${token}`} });
            const data = await res.json();
            if (data.success && data.results.length > 0) {
                let optionsHtml = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡πà‡∏≠‡∏¢ --</option>';
                data.results.forEach(s => {
                    const isBusy = (s.SellingStatus === 'Open' || s.TransactionStatus || s.ExchangeStatus === 'pending');
                    const statusText = isBusy ? " (‡∏ï‡∏¥‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°)" : "";
                    optionsHtml += `<option value="${s.ScheduleID}" ${isBusy ? 'disabled' : ''}>${moment(s.Nurse_Date).add(543, 'years').format('D MMM YY')} - ${s.ShiftName}${statusText}</option>`;
                });
                select.innerHTML = optionsHtml;
            } else {
                select.innerHTML = '<option value="" disabled>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏°‡∏≤‡πÅ‡∏•‡∏Å‡πÑ‡∏î‡πâ</option>';
            }
        } catch (err) { select.innerHTML = '<option value="" disabled>‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</option>'; }
    }

    async function openRequestModal(targetId, targetName, scheduleId) {
        document.getElementById('modal-target-name').innerText = targetName;
        document.getElementById('modal-target-user-id').value = targetId;
        document.getElementById('modal-target-schedule-id').value = scheduleId;
        const select = document.getElementById('my-offer-shift');
        select.innerHTML = '<option value="" disabled selected>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏é‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢...</option>';
        
        document.getElementById('requestModal').classList.remove('hidden');
        setTimeout(() => document.getElementById('requestModal').classList.add('opacity-100'), 10);
        document.getElementById('requestModalContent').classList.replace('scale-90', 'scale-100');

        try {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_BASE}/api/schedule/my-future-shifts/${currentUser.UserID}?targetScheduleId=${scheduleId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();

            if (data.success && data.results.length > 0) {
                let optionsHtml = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å --</option>';
                data.results.forEach(s => optionsHtml += `<option value="${s.ScheduleID}">${moment(s.Nurse_Date).add(543, 'years').format('D MMM YY')} - ${s.ShiftName}</option>`);
                select.innerHTML = optionsHtml;
            } else {
                let msg = data.message || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô";
                select.innerHTML = `<option value="" disabled>${msg}</option>`;
                Swal.fire({ icon:'info', title:'‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', text:msg, confirmButtonColor:'#4f46e5', customClass:{popup:'rounded-[2rem]'} });
            }
        } catch (err) { select.innerHTML = '<option value="" disabled>‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</option>'; }
    }

    async function handleCreatePost(e) {
        e.preventDefault();
        const token = localStorage.getItem('token');
        const scheduleId = document.getElementById('post-my-shift').value;
        if(!scheduleId) return;
        const btn = document.getElementById('btn-create-post');
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå...';

        try {
            const checkRes = await fetch(`${API_BASE}/api/swaps/check-status/${scheduleId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const statusData = await checkRes.json();
            if (statusData.success && (statusData.isSelling || statusData.isPending || statusData.isInTransaction)) {
                Swal.fire({ icon:'error', title:'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏î‡πâ', text:'‡πÄ‡∏ß‡∏£‡∏ô‡∏µ‡πâ‡∏ï‡∏¥‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', customClass:{popup:'rounded-[2rem]'} });
                btn.disabled = false; btn.innerHTML = originalText;
                return;
            }

            const res = await fetch(`${API_BASE}/api/posts/create`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                body: JSON.stringify({ userId: currentUser.UserID, scheduleId, desiredDate: document.getElementById('post-desired-date').value, note: document.getElementById('post-note').value })
            });
            const data = await res.json();
            if(data.success) { 
                window.closePostModal(); 
                fetchMyActivePost(); 
                Swal.fire({icon:'success', title:'‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer:1500, showConfirmButton:false, customClass:{popup:'rounded-[2rem]'}}); 
            }
        } catch (err) { Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
        finally { btn.disabled = false; btn.innerHTML = originalText; }
    }

    async function fetchMyActivePost() {
        const container = document.getElementById('my-posts-list');
        const token = localStorage.getItem('token'); 
        try {
            const res = await fetch(`${API_BASE}/api/posts/user/${currentUser.UserID}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            if(!data.success || !data.results.length) { container.innerHTML = `<div class="text-center py-10 opacity-30"><i class="fas fa-clipboard-list text-3xl mb-2"></i><p class="text-xs font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£</p></div>`; return; }
            container.innerHTML = data.results.map(post => `
                <div class="bracket-card bracket-black p-4 shadow-sm mb-3 animate-enter glass-card border-none">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-black text-indigo-400 uppercase tracking-tighter">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
                        <div class="flex gap-1">
                            <button onclick='window.openEditPostModal(${JSON.stringify(post)})' class="w-8 h-8 rounded-lg text-slate-400 hover:bg-amber-50 hover:text-amber-500 transition-all"><i class="fas fa-edit text-xs"></i></button>
                            <button onclick="window.deletePost('${post.PostID}', '${post.ScheduleID}')" class="w-8 h-8 rounded-lg text-slate-400 hover:bg-rose-50 hover:text-rose-500 transition-all"><i class="fas fa-trash-alt text-xs"></i></button>
                        </div>
                    </div>
                    <div class="text-sm font-black text-slate-800">${moment(post.Nurse_Date).add(543, 'years').format('D MMM YY')} (${post.ShiftName})</div>
                </div>`).join('');
        } catch(e) { container.innerHTML = '<div class="text-xs text-rose-400 text-center py-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; }
    }

    async function fetchIncomingRequests() {
        const container = document.getElementById('incoming-list');
        const badge = document.getElementById('incoming-badge');
        const token = localStorage.getItem('token'); 
        try {
            const res = await fetch(`${API_BASE}/api/swaps/incoming/${currentUser.UserID}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            if(data.success && data.results.length > 0) {
                badge.innerText = data.results.length; badge.classList.remove('hidden');
                container.innerHTML = data.results.map(req => {
                    const reqDate = moment(req.RequesterDate).add(543, 'years').format('D MMM');
                    const targetDate = moment(req.TargetDate).add(543, 'years').format('D MMM');
                    return `
                    <div class="bracket-card bracket-purple p-5 shadow-sm animate-enter glass-card border-none">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1 min-w-0">
                                <p class="text-[10px] font-black text-purple-500 uppercase tracking-widest mb-1">‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£‡πÉ‡∏´‡∏°‡πà</p>
                                <h4 class="font-black text-slate-800 truncate text-sm">${req.RequesterName}</h4>
                            </div>
                            <div class="flex gap-2 shrink-0 ml-4">
                                <button onclick="window.respondSwap('${req.SwapID}', 'reject')" class="w-10 h-10 flex items-center justify-center bg-rose-50 text-rose-500 rounded-2xl hover:bg-rose-500 hover:text-white transition shadow-sm"><i class="fas fa-times"></i></button>
                                <button onclick="window.respondSwap('${req.SwapID}', 'approve')" 
                                    style="background-color: #16a34a !important; color: white !important;" 
                                    class="w-10 h-10 flex items-center justify-center rounded-2xl shadow-lg shadow-green-100 transition active:scale-90 hover:opacity-90">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 p-3 bg-slate-50/50 rounded-2xl border border-slate-100">
                            <div class="flex-1 text-center"><p class="text-[9px] font-black text-slate-400 uppercase">‡πÅ‡∏•‡∏Å‡∏Å‡∏±‡∏ö</p><p class="text-[11px] font-black text-indigo-600">${reqDate} (${req.RequesterShiftName})</p></div>
                            <i class="fas fa-arrow-right-arrow-left text-slate-300 text-[10px]"></i>
                            <div class="flex-1 text-center"><p class="text-[9px] font-black text-slate-400 uppercase">‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p><p class="text-[11px] font-black text-emerald-600">${targetDate} (${req.TargetShiftName})</p></div>
                        </div>
                    </div>`;
                }).join('');
            } else { badge.classList.add('hidden'); container.innerHTML = '<div class="text-center py-10 opacity-30 text-xs font-bold italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>'; }
        } catch(e) { console.error(e); }
    }

    async function fetchPendingApprovals() {
        const container = document.getElementById('approval-list');
        const badge = document.getElementById('approval-badge');
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`${API_BASE}/api/admin/swaps/pending`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            if (data.success && data.results.length > 0) {
                badge.innerText = data.results.length;
                container.innerHTML = data.results.map(item => `
                <div class="bracket-card bracket-purple p-5 shadow-sm animate-enter glass-card border-none">
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm font-black text-slate-800">${item.ReqName} ‚Üî ${item.ResName}</div>
                        <div class="flex gap-2">
                            <button onclick="window.respondApproval('${item.exchange_id}', 'reject')" class="w-9 h-9 flex items-center justify-center bg-rose-50 text-rose-500 rounded-xl hover:bg-rose-500 hover:text-white transition"><i class="fas fa-times text-sm"></i></button>
                            <button onclick="window.respondApproval('${item.exchange_id}', 'approve')" 
                                style="background-color: #16a34a !important; color: white !important;" 
                                class="w-9 h-9 flex items-center justify-center rounded-xl shadow-md transition active:scale-95 hover:opacity-90">
                                <i class="fas fa-check text-sm"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-[10px] font-black">
                        <div class="bg-indigo-50/50 p-3 rounded-2xl text-indigo-600 text-center border border-indigo-100/50">${moment(item.ReqDate).add(543, 'years').format('D MMM YY')} (${item.ReqShift})</div>
                        <div class="bg-emerald-50/50 p-3 rounded-2xl text-emerald-600 text-center border border-emerald-100/50">${moment(item.ResDate).add(543, 'years').format('D MMM YY')} (${item.ResShift})</div>
                    </div>
                </div>`).join('');
            } else { container.innerHTML = '<div class="text-center py-10 opacity-30 text-xs font-bold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>'; badge.innerText = "0"; }
        } catch (err) { console.error(err); }
    }

    async function respondApproval(id, act) {
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`${API_BASE}/api/admin/swaps/action`, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${token}`}, body:JSON.stringify({ swapId:id, action:act, adminId:currentUser.UserID }) });
            const data = await res.json();
            if (data.success) { Swal.fire({icon:'success', title:'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer:1500, showConfirmButton:false, customClass:{popup:'rounded-[2rem]'}}); fetchPendingApprovals(); }
        } catch(e) {}
    }

    async function respondSwap(id, act) {
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`${API_BASE}/api/swaps/respond`, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${token}`}, body:JSON.stringify({ swapId:id, action:act, responderId:currentUser.UserID }) });
            const data = await res.json();
            if(data.success) { Swal.fire({icon:'success', title:'‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:act==='approve'?'‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢':'‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', timer:2000, showConfirmButton:false, customClass:{popup:'rounded-[2rem]'}}); fetchIncomingRequests(); }
        } catch(e) {}
    }

    async function deletePost(postId, scheduleId) {
        const confirm = await Swal.fire({ title:'‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®?', text:"‡∏´‡∏≤‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£", icon:'warning', showCancelButton:true, confirmButtonColor:'#f43f5e', confirmButtonText:'‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®', cancelButtonText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', customClass:{popup:'rounded-[2rem]'} });
        if (confirm.isConfirmed) {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_BASE}/api/posts/delete/${postId}`, { method:'DELETE', headers:{'Authorization':`Bearer ${token}`} });
            const data = await res.json();
            if(data.success) { fetchMyActivePost(); Swal.fire({icon:'success', title:'‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer:1000, showConfirmButton:false}); }
        }
    }

    async function openEditPostModal(post) {
        const token = localStorage.getItem('token');
        try {
            const checkRes = await fetch(`${API_BASE}/api/swaps/check-status/${post.ScheduleID}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const statusData = await checkRes.json();
            if (statusData.success && statusData.isPending) {
                return Swal.fire({ icon:'warning', title:'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ', text:'‡πÄ‡∏ß‡∏£‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô', customClass:{popup:'rounded-[2rem]'} });
            }
            document.getElementById('edit-post-id').value = post.PostID;
            document.getElementById('edit-post-note').value = post.Note || '';
            if (post.DesiredDate) document.getElementById('edit-desired-date')._flatpickr.setDate(post.DesiredDate);
            else document.getElementById('edit-desired-date')._flatpickr.clear();

            const modal = document.getElementById('editPostModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('opacity-100'), 10);
            document.getElementById('editPostModalContent').classList.replace('scale-90', 'scale-100');

            const res = await fetch(`${API_BASE}/api/schedule/my-future-shifts/${currentUser.UserID}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            if (data.success) {
                document.getElementById('edit-post-schedule-id').innerHTML = data.results.map(s => `<option value="${s.ScheduleID}" ${s.ScheduleID == post.ScheduleID ? 'selected' : ''}>${moment(s.Nurse_Date).add(543, 'years').format('D MMM YY')} - ${s.ShiftName}</option>`).join('');
            }
        } catch (err) { console.error(err); }
    }

    async function handleUpdatePost(e) {
        e.preventDefault();
        const token = localStorage.getItem('token');
        const body = { scheduleId: document.getElementById('edit-post-schedule-id').value, desiredDate: document.getElementById('edit-desired-date').value, note: document.getElementById('edit-post-note').value, userId: currentUser.UserID };
        try {
            const res = await fetch(`${API_BASE}/api/posts/update/${document.getElementById('edit-post-id').value}`, { method:'PUT', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${token}`}, body:JSON.stringify(body) });
            const data = await res.json();
            if (data.success) { Swal.fire({icon:'success', title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer:1000, showConfirmButton:false}); window.closeEditPostModal(); fetchMyActivePost(); }
        } catch (err) { console.error(err); }
    }
    function clearEditDate() { document.getElementById('edit-desired-date')._flatpickr.clear(); }
    </script>
</body>
</html>