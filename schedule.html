<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ตารางเวรส่วนตัว - AUTONURSESHIFT</title>
    
    <link rel="stylesheet" href="./lib/flatpickr.css">
    <script src="./lib/flatpickr.js"></script>
    <script src="./lib/th.js"></script>
    <link rel="stylesheet" href="./lib/fontawesome/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.min.js"></script>
    
    <script src="components.js"></script> 

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap');

        /* --- CORE THEME --- */
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f0f4f8;
            background-image: url('background06.png'); 
            background-size: cover; 
            background-position: center;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent; 
            color: #1e293b;
            margin: 0;
            overflow: hidden;
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 6rem); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* --- GLASSMORPHISM --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .glass-modal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        /* --- CALENDAR GRID (ปรับให้สวยและ Dynamic) --- */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            width: 100%;
        }

        .day-cell {
            aspect-ratio: 1 / 1;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .day-cell.today {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.35);
            transform: scale(1.05);
            z-index: 10;
        }

        .day-cell.today .dot { background-color: #fff !important; opacity: 0.9; }
        
        .day-cell.has-shift:not(.today):hover { 
            background-color: rgba(255,255,255,0.9); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        }

        /* DOTS INDICATORS */
        .dot { width: 5px; height: 5px; border-radius: 50%; margin-top: 4px; }
        .dot-morning { background-color: #3b82f6; box-shadow: 0 0 6px rgba(59, 130, 246, 0.6); }
        .dot-afternoon { background-color: #f97316; box-shadow: 0 0 6px rgba(249, 115, 22, 0.6); }
        .dot-night { background-color: #a855f7; box-shadow: 0 0 6px rgba(168, 85, 247, 0.6); }

        /* --- ANIMATIONS --- */
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-pop { opacity: 0; animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        /* MODAL STYLES */
        .shift-card-large { padding: 1.2rem; margin-bottom: 1rem; border-radius: 1.5rem; }
        .time-display-large { font-size: 1.5rem; font-weight: 800; }

        @media (min-width: 768px) {
            .glass-panel { max-width: 800px; margin: 0 auto; padding: 2rem; }
            .calendar-grid { gap: 15px; }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <app-header></app-header>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        
        <div class="glass-header z-20 px-6 py-4 flex justify-between items-end shadow-sm">
            <div>
                <button onclick="openSelectionModal()" class="group flex items-center gap-1.5 text-[11px] font-bold text-indigo-500 uppercase tracking-wider mb-1 transition hover:text-indigo-700">
                    <span class="w-5 h-5 rounded-full bg-indigo-50 flex items-center justify-center group-hover:bg-indigo-100 transition"><i class="fas fa-exchange-alt text-[9px]"></i></span>
                    เปลี่ยนมุมมอง
                </button>
                
                <button onclick="openDatePicker()" class="flex items-center gap-2 group transition-all active:scale-95">
                    <h1 id="monthYearDisplay" class="text-3xl font-extrabold text-slate-800 tracking-tight leading-none group-hover:text-indigo-600 transition">...</h1>
                    <div class="w-6 h-6 rounded-full border border-slate-200 flex items-center justify-center text-slate-400 group-hover:border-indigo-200 group-hover:text-indigo-500 transition">
                        <i class="fas fa-chevron-down text-[10px]"></i>
                    </div>
                </button>
            </div>

            <div class="flex gap-2 mb-1">
                <button onclick="changeMonth(-1)" class="w-10 h-10 rounded-2xl bg-white/60 border border-white/50 shadow-sm flex items-center justify-center text-slate-500 hover:bg-white transition active:scale-90"><i class="fas fa-chevron-left"></i></button>
                <button onclick="changeMonth(1)" class="w-10 h-10 rounded-2xl bg-white/60 border border-white/50 shadow-sm flex items-center justify-center text-slate-500 hover:bg-white transition active:scale-90"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto pb-32 p-4 md:p-6">
            <div class="glass-panel rounded-[2.5rem] p-5 md:p-8 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-indigo-200 rounded-full blur-3xl opacity-20 pointer-events-none"></div>
                <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-purple-200 rounded-full blur-3xl opacity-20 pointer-events-none"></div>

                <div class="grid grid-cols-7 mb-6 text-center">
                    <div class="text-xs font-bold text-rose-500">อา</div>
                    <div class="text-xs font-bold text-slate-400">จ</div>
                    <div class="text-xs font-bold text-slate-400">อ</div>
                    <div class="text-xs font-bold text-slate-400">พ</div>
                    <div class="text-xs font-bold text-slate-400">พฤ</div>
                    <div class="text-xs font-bold text-slate-400">ศ</div>
                    <div class="text-xs font-bold text-indigo-500">ส</div>
                </div>

                <div id="calendarGrid" class="calendar-grid relative z-10"></div>
            </div>

            <div class="mt-8 flex justify-center gap-6">
                <div class="flex items-center gap-2 bg-white/60 px-4 py-2 rounded-full border border-white shadow-sm backdrop-blur-sm"><div class="w-3 h-3 rounded-full dot-morning"></div><span class="text-xs font-bold text-slate-600">เช้า</span></div>
                <div class="flex items-center gap-2 bg-white/60 px-4 py-2 rounded-full border border-white shadow-sm backdrop-blur-sm"><div class="w-3 h-3 rounded-full dot-afternoon"></div><span class="text-xs font-bold text-slate-600">บ่าย</span></div>
                <div class="flex items-center gap-2 bg-white/60 px-4 py-2 rounded-full border border-white shadow-sm backdrop-blur-sm"><div class="w-3 h-3 rounded-full dot-night"></div><span class="text-xs font-bold text-slate-600">ดึก</span></div>
            </div>
        </div>
    </main>

    <app-navbar></app-navbar>

    <div id="scheduleTypeModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-md hidden opacity-0 transition-all duration-300">
        <div class="glass-modal w-full max-w-sm rounded-[2.5rem] p-8 text-center transform scale-90 transition-transform duration-300" id="typeModalContent">
            <h2 class="text-2xl font-extrabold text-slate-800 mb-6">เลือกมุมมอง</h2>
            <div class="space-y-4">
                <button onclick="selectScheduleType('personal')" class="w-full bg-white/80 p-5 rounded-2xl flex items-center gap-4 border border-white hover:bg-white transition shadow-sm group">
                    <div class="w-12 h-12 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl group-hover:bg-indigo-600 group-hover:text-white transition"><i class="fas fa-user-nurse"></i></div>
                    <div class="text-left"><h3 class="font-bold text-slate-800">เวรของฉัน</h3><p class="text-[10px] text-slate-400">ตารางงานส่วนตัว</p></div>
                </button>
                <button onclick="selectScheduleType('full')" class="w-full bg-white/80 p-5 rounded-2xl flex items-center gap-4 border border-white hover:bg-white transition shadow-sm group">
                    <div class="w-12 h-12 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center text-xl group-hover:bg-purple-600 group-hover:text-white transition"><i class="fas fa-users"></i></div>
                    <div class="text-left"><h3 class="font-bold text-slate-800">ตารางเวรรวม</h3><p class="text-[10px] text-slate-400">ภาพรวมทั้งแผนก</p></div>
                </button>
            </div>
        </div>
    </div>

    <div id="detailSheetBackdrop" class="fixed inset-0 z-40 bg-slate-900/20 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300" onclick="closeDetailSheet()"></div>
    <div id="detailSheet" class="fixed bottom-0 left-0 right-0 z-50 glass-modal rounded-t-[2.5rem] transform translate-y-full transition-transform duration-300 ease-out max-w-screen-md mx-auto">
        <div class="p-6 pb-safe">
            <div class="w-12 h-1.5 bg-slate-300/50 rounded-full mx-auto mb-8"></div> 
            <div id="sheetContent"></div>
            <button onclick="closeDetailSheet()" class="w-full mt-4 bg-slate-100/80 text-slate-600 font-bold py-4 rounded-2xl">ปิดหน้าต่าง</button>
        </div>
    </div>

    <div id="sellShiftModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/60 backdrop-blur-md hidden opacity-0 transition-all duration-300">
        <div class="glass-modal w-full max-w-sm rounded-[2.5rem] p-8 text-center" id="sellModalContent">
            <div class="w-16 h-16 bg-emerald-100 text-emerald-500 rounded-full mx-auto flex items-center justify-center mb-4 text-2xl shadow-inner"><i class="fas fa-dollar-sign"></i></div>
            <h2 class="text-xl font-extrabold text-slate-800 mb-2">ประกาศขายเวร</h2>
            <div class="mb-4 bg-white/50 p-4 rounded-2xl border border-white/60">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">ราคา (บาท)</label>
                <input type="number" id="sellPrice" value="500" class="w-full bg-transparent text-center text-2xl font-black text-slate-700 focus:outline-none">
            </div>
            <textarea id="sellMessage" rows="2" class="w-full bg-slate-50 border rounded-xl p-3 text-sm mb-6" placeholder="ข้อความเพิ่มเติม..."></textarea>
            <div class="space-y-3">
                <button id="btn-confirm-sell" onclick="confirmSell()" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-2xl shadow-lg">ยืนยันการขาย</button>
                <button onclick="closeSellModal()" class="w-full py-3 text-slate-400 font-bold">ยกเลิก</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let currentDate = new Date();
        let shiftsData = [];
        let currentUser = JSON.parse(localStorage.getItem('user'));
        const API_BASE = "YOUR_API_BASE_URL"; // ปรับให้ตรงกับ API ของคุณ
        const THAI_MONTHS_SHORT = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
        const THAI_MONTHS_FULL = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];

        document.addEventListener('DOMContentLoaded', () => {
            if(!localStorage.getItem('token')) window.location.href = 'login.html';
            renderHeader();
            loadSchedule();
        });

        // --- CALENDAR RENDER LOGIC ---
        async function loadSchedule() {
            const month = currentDate.getMonth() + 1;
            const year = currentDate.getFullYear();
            const grid = document.getElementById('calendarGrid');
            const token = localStorage.getItem('token'); 
            
            grid.innerHTML = '<div class="col-span-7 py-24 text-center"><i class="fas fa-spinner fa-spin text-indigo-500 text-3xl"></i></div>';

            try {
                const res = await fetch(`${API_BASE}/api/monthly-schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ userId: currentUser.UserID, month, year })
                });
                const data = await res.json();
                if(data.success) {
                    shiftsData = data.shifts;
                    renderGrid(month, year);
                }
            } catch (err) { console.error(err); }
        }

        function renderGrid(month, year) {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            const today = new Date();

            // คำนวณแถวที่ต้องวาด (ประหยัดพื้นที่ ถ้า 5 แถวพอ ก็วาดแค่ 35 ช่อง)
            const totalCellsNeeded = firstDay + daysInMonth;
            const totalCellsToRender = Math.ceil(totalCellsNeeded / 7) * 7;

            for(let i=0; i < totalCellsToRender; i++) {
                const dayNumber = i - firstDay + 1;
                const cell = document.createElement('div');
                
                if(dayNumber <= 0 || dayNumber > daysInMonth) {
                    cell.className = "day-cell opacity-0 pointer-events-none";
                    grid.appendChild(cell);
                    continue;
                }

                const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(dayNumber).padStart(2,'0')}`;
                const dayShifts = shiftsData.filter(s => s.Nurse_Date.startsWith(dateStr)); 
                const hasShift = dayShifts.length > 0;
                
                let isToday = (dayNumber === today.getDate() && month === (today.getMonth()+1) && year === today.getFullYear());
                let cellClass = `day-cell animate-pop`;
                
                if(isToday) cellClass += ' today';
                else cellClass += hasShift ? ' has-shift bg-white/50 cursor-pointer' : ' text-slate-400 bg-white/10';

                let dotsHtml = '<div class="flex gap-0.5 justify-center mt-1">'; 
                if(hasShift) {
                    dayShifts.forEach(shift => {
                        let dotColor = 'bg-slate-300';
                        if(shift.ShiftName.includes('เช้า')) dotColor = 'dot-morning';
                        else if(shift.ShiftName.includes('บ่าย')) dotColor = 'dot-afternoon';
                        else if(shift.ShiftName.includes('ดึก')) dotColor = 'dot-night';
                        dotsHtml += `<div class="dot ${dotColor}"></div>`;
                    });
                }
                dotsHtml += '</div>';

                cell.className = cellClass;
                cell.style.animationDelay = `${(dayNumber * 0.02).toFixed(2)}s`;
                cell.innerHTML = `<span class="text-sm font-bold z-10">${dayNumber}</span>${dotsHtml}`;

                if(hasShift) cell.onclick = () => openDetailSheet(dayShifts, dayNumber);
                grid.appendChild(cell);
            }
        }

        // --- NAVIGATION FUNCTIONS ---
        function renderHeader() {
            document.getElementById('monthYearDisplay').innerText = `${THAI_MONTHS_FULL[currentDate.getMonth()]} ${currentDate.getFullYear() + 543}`;
        }
        function changeMonth(d) {
            currentDate.setMonth(currentDate.getMonth() + d);
            renderHeader();
            loadSchedule();
        }

        // --- MODAL & UI LOGIC ---
        function openSelectionModal() {
            const modal = document.getElementById('scheduleTypeModal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
        }

        function closeSelectionModal() {
            const modal = document.getElementById('scheduleTypeModal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function openDetailSheet(shifts, day) {
            const backdrop = document.getElementById('detailSheetBackdrop');
            const sheet = document.getElementById('detailSheet');
            const content = document.getElementById('sheetContent');
            const dateStr = `${day} ${THAI_MONTHS_FULL[currentDate.getMonth()]} ${currentDate.getFullYear()+543}`;
            
            let shiftsHtml = shifts.map(shift => {
                let color = shift.ShiftName.includes('เช้า') ? 'text-blue-50 bg-blue-500' : 
                            shift.ShiftName.includes('บ่าย') ? 'text-orange-50 bg-orange-500' : 'text-purple-50 bg-purple-500';
                return `
                    <div class="shift-card-large glass-panel flex justify-between items-center">
                        <div>
                            <div class="text-[10px] font-bold uppercase opacity-60">${shift.ShiftName}</div>
                            <div class="time-display-large text-slate-800">${shift.StartTime.slice(0,5)} - ${shift.EndTime.slice(0,5)}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="requestTrade('${shift.ScheduleID}')" class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-xl text-xs font-bold">แลกเวร</button>
                            <button onclick="openSellModal('${shift.ScheduleID}')" class="px-4 py-2 bg-emerald-50 text-emerald-600 rounded-xl text-xs font-bold">ขายเวร</button>
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = `<h2 class="text-2xl font-black text-center mb-6">${dateStr}</h2>` + shiftsHtml;
            backdrop.classList.remove('hidden');
            setTimeout(() => { backdrop.classList.remove('opacity-0'); sheet.classList.remove('translate-y-full'); }, 10);
        }

        function closeDetailSheet() {
            const backdrop = document.getElementById('detailSheetBackdrop');
            const sheet = document.getElementById('detailSheet');
            sheet.classList.add('translate-y-full');
            backdrop.classList.add('opacity-0');
            setTimeout(() => { backdrop.classList.add('hidden'); }, 300);
        }

        // --- BUSINESS LOGIC STUBS ---
        function selectScheduleType(type) {
            if(type === 'full') window.location.href = 'fullschedule.html';
            closeSelectionModal();
        }

        function openSellModal(id) {
            closeDetailSheet();
            const modal = document.getElementById('sellShiftModal');
            modal.setAttribute('data-id', id);
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
        }

        function closeSellModal() {
            document.getElementById('sellShiftModal').classList.add('opacity-0');
            setTimeout(() => { document.getElementById('sellShiftModal').classList.add('hidden'); }, 300);
        }

        async function confirmSell() {
            // โค้ดส่งข้อมูลไป API เพื่อบันทึกลงฐานข้อมูล PostSell
            Swal.fire('สำเร็จ', 'ประกาศขายเวรเรียบร้อยแล้ว', 'success');
            closeSellModal();
        }
    </script>
</body>
</html>