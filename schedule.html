<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß - AUTONURSESHIFT</title>
    
    <link href="./style.css" rel="stylesheet">

    <link rel="stylesheet" href="./lib/flatpickr.css">
    <script src="./lib/flatpickr.js"></script>
    <script src="./lib/th.js"></script>

    <link rel="stylesheet" href="./lib/fontawesome/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.min.js"></script>

    <script src="components.js"></script> 

    <style>
        /* --- CORE THEME --- */
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f0f4f8;
            background-image: url('background06.png'); 
            background-size: cover; 
            background-position: center;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent; 
            color: #1e293b;
            overscroll-behavior: none;
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 6rem); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* --- GLASSMORPHISM --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .glass-modal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        /* --- CALENDAR STYLES --- */
        .day-cell {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 18px;
        }
        .day-cell.today {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.35);
            transform: scale(1.05);
            z-index: 10;
        }
        .day-cell.today .dot { background-color: #fff !important; opacity: 0.9; }
        .day-cell.has-shift:not(.today):hover { 
            background-color: rgba(255,255,255,0.9); box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏£ (Shift Bar) */
        .shift-bar {
            width: 95%;
            font-size: 9px;
            font-weight: 600;
            padding: 2px 6px;
            margin-top: 2px;
            border-radius: 6px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
            line-height: 1.2;
        }

        /* ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ß‡∏£ */
        .bar-morning { background: linear-gradient(90deg, #3b82f6, #60a5fa); box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); }
        .bar-afternoon { background: linear-gradient(90deg, #f97316, #fb923c); box-shadow: 0 2px 4px rgba(249, 115, 22, 0.2); }
        .bar-night { background: linear-gradient(90deg, #a855f7, #c084fc); box-shadow: 0 2px 4px rgba(168, 85, 247, 0.2); }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á day-cell ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ */
        .day-cell {
            height: auto !important;
            min-height: 4.5rem; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            padding: 4px 0;
            justify-content: flex-start !important; /* ‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
        }

        .day-cell span.date-number {
            margin-bottom: 2px;
            font-size: 13px;
        }

        /* --- ANIMATIONS --- */
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-pop { opacity: 0; animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô Modal ‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
        .shift-card-large {
            padding: 1.5rem !important; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô */
            margin-bottom: 1.25rem !important;
            border-radius: 2rem !important;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î */
        .time-display-large {
            font-size: 1.75rem !important; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 28px */
            letter-spacing: -0.02em;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠) */
        .action-btn-large {
            padding: 0.75rem 1.25rem !important;
            font-size: 0.9rem !important;
            min-width: 80px;
        }
        @media (min-width: 768px) {
            .glass-panel {
                max-width: 90% !important; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏£ */
                margin: 0 auto;
                padding: 1.5rem !important; 
            }

            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏±‡∏ô */
            .day-cell {
                height: auto !important; /* ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ß‡∏£ */
                min-height: 6rem !important; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏°‡∏î‡∏∏‡∏• */
                border-radius: 20px !important;
                padding: 8px 4px !important;
            }

            .day-cell span.date-number {
                font-size: 1.2rem !important;
                margin-bottom: 4px;
            }

            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà */
            .shift-bar {
                font-size: 10px !important;
                padding: 3px 8px !important;
                border-radius: 8px !important;
                width: 90% !important;
            }

            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤) */
            .dot {
                display: none !important;
            }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <app-header></app-header>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        
        <div class="glass-header z-20 px-6 py-4 flex justify-between items-end shadow-sm">
            <div>
                <button onclick="openSelectionModal()" class="group flex items-center gap-1.5 text-[11px] font-bold text-indigo-500 uppercase tracking-wider mb-1 transition hover:text-indigo-700">
                    <span class="w-5 h-5 rounded-full bg-indigo-50 flex items-center justify-center group-hover:bg-indigo-100 transition"><i class="fas fa-exchange-alt text-[9px]"></i></span>
                    ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á
                </button>
                
                <button onclick="openDatePicker()" class="flex items-center gap-2 group transition-all active:scale-95">
                    <h1 id="monthYearDisplay" class="text-3xl font-extrabold text-slate-800 tracking-tight leading-none group-hover:text-indigo-600 transition">...</h1>
                    <div class="w-6 h-6 rounded-full border border-slate-200 flex items-center justify-center text-slate-400 group-hover:border-indigo-200 group-hover:text-indigo-500 transition">
                        <i class="fas fa-chevron-down text-[10px]"></i>
                    </div>
                </button>
            </div>

            <div class="flex gap-2 mb-1">
                <button onclick="changeMonth(-1)" class="w-10 h-10 rounded-2xl bg-white/60 border border-white/50 shadow-sm flex items-center justify-center text-slate-500 hover:bg-white hover:text-indigo-600 hover:shadow-md transition active:scale-90"><i class="fas fa-chevron-left"></i></button>
                <button onclick="changeMonth(1)" class="w-10 h-10 rounded-2xl bg-white/60 border border-white/50 shadow-sm flex items-center justify-center text-slate-500 hover:bg-white hover:text-indigo-600 hover:shadow-md transition active:scale-90"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto pb-32 p-4 md:p-6">
            
            <div class="glass-panel rounded-[2rem] p-5 md:p-8 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-indigo-200 rounded-full blur-3xl opacity-20 pointer-events-none"></div>
                <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-purple-200 rounded-full blur-3xl opacity-20 pointer-events-none"></div>

                <div class="grid grid-cols-7 mb-6 text-center">
                    <div class="text-xs font-bold text-rose-500">‡∏≠‡∏≤</div>
                    <div class="text-xs font-bold text-slate-400">‡∏à</div>
                    <div class="text-xs font-bold text-slate-400">‡∏≠</div>
                    <div class="text-xs font-bold text-slate-400">‡∏û</div>
                    <div class="text-xs font-bold text-slate-400">‡∏û‡∏§</div>
                    <div class="text-xs font-bold text-slate-400">‡∏®</div>
                    <div class="text-xs font-bold text-indigo-500">‡∏™</div>
                </div>

                <div id="calendarGrid" class="grid grid-cols-7 gap-y-2 gap-x-1 md:gap-4 relative z-10"></div>
            </div>

            <div class="mt-6 flex justify-center gap-6">
                <div class="flex items-center gap-2 bg-white/60 px-3 py-1.5 rounded-full border border-white shadow-sm backdrop-blur-sm"><div class="w-2.5 h-2.5 rounded-full dot-morning"></div><span class="text-[10px] font-bold text-slate-600">‡πÄ‡∏ä‡πâ‡∏≤</span></div>
                <div class="flex items-center gap-2 bg-white/60 px-3 py-1.5 rounded-full border border-white shadow-sm backdrop-blur-sm"><div class="w-2.5 h-2.5 rounded-full dot-afternoon"></div><span class="text-[10px] font-bold text-slate-600">‡∏ö‡πà‡∏≤‡∏¢</span></div>
                <div class="flex items-center gap-2 bg-white/60 px-3 py-1.5 rounded-full border border-white shadow-sm backdrop-blur-sm"><div class="w-2.5 h-2.5 rounded-full dot-night"></div><span class="text-[10px] font-bold text-slate-600">‡∏î‡∏∂‡∏Å</span></div>
            </div>
        </div>
    </main>

    <app-navbar></app-navbar>

    <div id="scheduleTypeModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-md p-6 transition-opacity duration-300 hidden opacity-0">
        <div class="glass-modal w-full max-w-sm rounded-[2.5rem] p-8 text-center transform scale-90 transition-all duration-300 relative overflow-hidden" id="typeModalContent">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
            <div class="w-20 h-20 bg-gradient-to-br from-indigo-100 to-white rounded-[2rem] mx-auto flex items-center justify-center shadow-inner mb-6 border border-white"><i class="fas fa-layer-group text-4xl text-indigo-500 drop-shadow-sm"></i></div>
            <h2 class="text-2xl font-extrabold text-slate-800 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</h2>
            <p class="text-slate-500 text-sm mb-8 px-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</p>
            <div class="space-y-3">
                <button onclick="selectScheduleType('personal')" class="w-full bg-white/80 hover:bg-white border border-white/60 p-4 rounded-2xl flex items-center gap-4 transition-all duration-300 shadow-sm hover:shadow-xl hover:shadow-indigo-100/50 hover:-translate-y-1 group">
                    <div class="w-12 h-12 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl shadow-inner group-hover:bg-indigo-600 group-hover:text-white transition-colors duration-300"><i class="fas fa-user-nurse"></i></div>
                    <div class="text-left flex-1"><h3 class="font-bold text-slate-800 group-hover:text-indigo-700 transition">‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3><p class="text-[10px] text-slate-400">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</p></div>
                    <i class="fas fa-check-circle text-indigo-500 transition"></i>
                </button>
                <button onclick="selectScheduleType('full')" class="w-full bg-white/80 hover:bg-white border border-white/60 p-4 rounded-2xl flex items-center gap-4 transition-all duration-300 shadow-sm hover:shadow-xl hover:shadow-purple-100/50 hover:-translate-y-1 group">
                    <div class="w-12 h-12 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center text-xl shadow-inner group-hover:bg-purple-600 group-hover:text-white transition-colors duration-300"><i class="fas fa-users"></i></div>
                    <div class="text-left flex-1"><h3 class="font-bold text-slate-800 group-hover:text-purple-700 transition">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏£‡∏ß‡∏°</h3><p class="text-[10px] text-slate-400">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ú‡∏ô‡∏Å</p></div>
                    <i class="fas fa-chevron-right text-slate-300 group-hover:text-purple-400 transition"></i>
                </button>
            </div>
            <div class="mt-8"><a href="#" id="modal-home-link" class="text-xs text-slate-400 hover:text-indigo-600 font-bold transition uppercase tracking-wide">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></div>
        </div>
    </div>

    <div id="datePickerModal" class="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-md hidden opacity-0 transition-opacity duration-300 flex items-center justify-center p-6">
        <div class="glass-modal w-full max-w-sm rounded-[2.5rem] p-6 transform scale-95 transition-transform duration-300" id="datePickerContent">
            <div class="flex justify-between items-center mb-6 px-2">
                <h3 class="text-xl font-bold text-slate-800">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                <button onclick="closeDatePicker()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex justify-center items-center gap-4 mb-6 bg-slate-50/50 p-2 rounded-2xl border border-white">
                <button onclick="adjustPickerYear(-1)" class="w-10 h-10 rounded-xl bg-white shadow-sm text-slate-600 hover:text-indigo-600 active:scale-90 transition"><i class="fas fa-minus"></i></button>
                <span id="pickerYearDisplay" class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 px-4">2568</span>
                <button onclick="adjustPickerYear(1)" class="w-10 h-10 rounded-xl bg-white shadow-sm text-slate-600 hover:text-indigo-600 active:scale-90 transition"><i class="fas fa-plus"></i></button>
            </div>
            <div class="grid grid-cols-3 gap-3"></div>
        </div>
    </div>

    <div id="detailSheetBackdrop" class="fixed inset-0 z-40 bg-slate-900/20 backdrop-blur-sm hidden transition-opacity duration-300" onclick="closeDetailSheet()"></div>
    <div id="detailSheet" class="fixed bottom-0 left-0 right-0 z-50 glass-modal rounded-t-[2.5rem] shadow-[0_-10px_60px_rgba(0,0,0,0.15)] transform translate-y-full transition-transform duration-300 ease-out max-w-screen-md mx-auto border-b-0">
        <div class="p-6 pb-safe">
            <div class="w-12 h-1.5 bg-slate-300/50 rounded-full mx-auto mb-8"></div> 
            <div id="sheetContent"></div>
            <button onclick="closeDetailSheet()" class="w-full mt-4 bg-slate-100/80 text-slate-600 font-bold py-4 rounded-2xl hover:bg-slate-200 transition backdrop-blur-md">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <div id="postModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[70] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="glass-modal w-full max-w-md p-6 rounded-[2.5rem] shadow-2xl transform scale-90 transition-all duration-300 relative overflow-hidden" id="postModalContent">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="w-10 h-10 rounded-xl bg-pink-50 text-pink-500 flex items-center justify-center"><i class="fas fa-bullhorn"></i></span>
                    ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏´‡∏≤‡∏Ñ‡∏ô‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£
                </h3>
                <button onclick="closePostModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>

            <form id="createPostForm" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1.5 uppercase tracking-wide">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡πá‡πÑ‡∏î‡πâ)</label>
                    <input type="text" id="post-desired-date" placeholder="‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ / ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 transition">
                </div>

                <div class="bg-pink-50/50 rounded-2xl p-4 border border-pink-100">
                    <label class="block text-xs font-bold text-pink-800 mb-2 uppercase tracking-wide">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢</label>
                    <div class="relative">
                        <select id="post-my-shift" class="w-full bg-white border border-pink-200 rounded-xl p-3 text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-pink-500 cursor-pointer appearance-none" required>
                            <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-pink-300 text-xs pointer-events-none"></i>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1.5 uppercase tracking-wide">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="post-note" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-pink-500 placeholder-slate-400" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏¥‡∏î‡∏ò‡∏∏‡∏£‡∏∞‡∏î‡πà‡∏ß‡∏ô..."></textarea>
                </div>

                <button type="submit" id="btn-create-post" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-3.5 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-paper-plane"></i> ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô
                </button>
            </form>
        </div>
    </div>

    <div id="sellShiftModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/60 backdrop-blur-md hidden opacity-0 transition-opacity duration-300 p-4">
        <div class="glass-modal w-full max-w-sm rounded-[2.5rem] p-8 text-center transform scale-90 transition-all duration-300 relative overflow-hidden" id="sellModalContent">
            
            <div class="w-20 h-20 bg-emerald-100 text-emerald-500 rounded-full mx-auto flex items-center justify-center mb-6 text-3xl shadow-inner">
                <i class="fas fa-dollar-sign"></i>
            </div>

            <h2 class="text-2xl font-extrabold text-slate-800 mb-2">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ß‡∏£</h2>
            <p class="text-slate-500 text-sm mb-6">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ</p>

            <div class="mb-4 bg-white/50 p-4 rounded-2xl border border-white/60">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)</label>
                <input type="number" id="sellPrice" value="500" class="w-full bg-transparent text-center text-3xl font-black text-slate-700 focus:outline-none border-b-2 border-slate-200 focus:border-emerald-500 transition pb-2" placeholder="0.00">
            </div>

            <div class="mb-6 text-left">
                <label class="block text-xs font-bold text-slate-400 mb-1.5 uppercase tracking-wide">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <textarea id="sellMessage" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 placeholder-slate-400" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡πÑ‡∏î‡πâ, ‡∏£‡∏µ‡∏ö‡∏Ç‡∏≤‡∏¢..."></textarea>
            </div>

            <div class="space-y-3">
                <button id="btn-confirm-sell" onclick="confirmSell()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-200 transition transform active:scale-95">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
                </button>
                <button onclick="closeSellModal()" class="w-full py-3 text-slate-400 font-bold hover:text-slate-600 transition">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
            </div>
        </div>
    </div>


    <script>
        // ‚úÖ ‡πÉ‡∏ä‡πâ API_BASE ‡∏à‡∏≤‡∏Å components.js
        let currentDate = new Date();
        let pickerYear = currentDate.getFullYear();
        let shiftsData = [];
        let currentUser = null; 
        const THAI_MONTHS_SHORT = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
        const THAI_MONTHS_FULL = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('user');
            const token = localStorage.getItem('token'); 

            if(!userStr || !token) return window.location.href = 'login.html';
            
            currentUser = JSON.parse(userStr);

            const homeUrl = (currentUser.RoleID == 1) ? 'Headnurse_dashboard.html' : 'dashboard.html';
            document.getElementById('modal-home-link').href = homeUrl;

            flatpickr("#post-desired-date", { locale: "th", dateFormat: "Y-m-d", altInput: true, altFormat: "j F Y", disableMobile: "true" });

            const perfEntries = performance.getEntriesByType("navigation");
            let isReload = false;
            if (perfEntries.length > 0 && perfEntries[0].type === 'reload') isReload = true;

            const referrer = document.referrer || ""; 
            const cameFromFullSchedule = referrer.includes("fullschedule.html");

            if (!isReload && !cameFromFullSchedule) {
                openSelectionModal();
            }

            renderHeader();
            loadSchedule();
            generatePickerMonths();

            document.getElementById('createPostForm').addEventListener('submit', handleCreatePost);
        });

        function renderHeader() {
            const monthStr = THAI_MONTHS_FULL[currentDate.getMonth()];
            const yearStr = currentDate.getFullYear() + 543;
            document.getElementById('monthYearDisplay').innerText = `${monthStr} ${yearStr}`;
        }

        async function loadSchedule() {
            const month = currentDate.getMonth() + 1;
            const year = currentDate.getFullYear();
            const grid = document.getElementById('calendarGrid');
            const token = localStorage.getItem('token'); 
            grid.innerHTML = '<div class="col-span-7 py-24 text-center"><i class="fas fa-spinner fa-spin text-indigo-500 text-3xl"></i></div>';

            try {
                const res = await fetch(`${API_BASE}/api/monthly-schedule`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // ‚úÖ ‡πÅ‡∏ô‡∏ö Token
                    },
                    body: JSON.stringify({ userId: currentUser.UserID, month, year })
                });

                if (res.status === 401) { window.location.href = 'login.html'; return; } // ‚úÖ 401 Check

                const data = await res.json();
                if(data.success) {
                    shiftsData = data.shifts;
                    renderGrid(month, year);
                } else {
                    grid.innerHTML = '<div class="col-span-7 py-20 text-center text-slate-400 font-light">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                }
            } catch (err) {
                grid.innerHTML = '<div class="col-span-7 py-20 text-center text-red-400 font-light">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
            }
        }

        function renderGrid(month, year) {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            const today = new Date();

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            for(let day=1; day<=daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const dayShifts = shiftsData.filter(s => s.Nurse_Date.startsWith(dateStr)); 
                const hasShift = dayShifts.length > 0;
                
                let isToday = (day === today.getDate() && month === (today.getMonth()+1) && year === today.getFullYear());
                let cellClass = `day-cell relative flex flex-col items-center cursor-pointer select-none animate-pop`;
                
                if(isToday) cellClass += ' today';
                else cellClass += hasShift ? ' has-shift' : ' text-slate-400';

                // --- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Dot ‡πÄ‡∏õ‡πá‡∏ô Bar ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
                let barsHtml = '<div class="flex flex-col w-full items-center gap-0.5">'; 
                if(hasShift) {
                    dayShifts.forEach(shift => {
                        let barColorClass = 'bg-slate-400';
                        if(shift.ShiftName.includes('‡πÄ‡∏ä‡πâ‡∏≤')) barColorClass = 'bar-morning';
                        else if(shift.ShiftName.includes('‡∏ö‡πà‡∏≤‡∏¢')) barColorClass = 'bar-afternoon';
                        else if(shift.ShiftName.includes('‡∏î‡∏∂‡∏Å')) barColorClass = 'bar-night';
                        
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "‡πÄ‡∏ä‡πâ‡∏≤", "‡∏ö‡πà‡∏≤‡∏¢", "‡∏î‡∏∂‡∏Å"
                        barsHtml += `<div class="shift-bar ${barColorClass}">${shift.ShiftName}</div>`;
                    });
                }
                barsHtml += '</div>';

                const delay = (day * 0.02).toFixed(2);
                const cell = document.createElement('div');
                cell.className = cellClass;
                cell.style.animationDelay = `${delay}s`;
                cell.innerHTML = `<span class="date-number font-bold z-10">${day}</span>${barsHtml}`;

                if(hasShift) cell.onclick = () => openDetailSheet(dayShifts, day);
                grid.appendChild(cell);
            }
        }

       // --- SHEET LOGIC (Updated: 2 Buttons) ---
        function openDetailSheet(shifts, day) {
            const backdrop = document.getElementById('detailSheetBackdrop');
            const sheet = document.getElementById('detailSheet');
            const content = document.getElementById('sheetContent');
            
            const dateStr = `${day} ${THAI_MONTHS_FULL[currentDate.getMonth()]} ${currentDate.getFullYear()+543}`;
            
            let shiftsHtml = '';
            shifts.forEach(shift => {
                let icon = 'fa-sun';
                let color = 'text-blue-500 bg-blue-50';
                if(shift.ShiftName.includes('‡∏ö‡πà‡∏≤‡∏¢')) { icon = 'fa-cloud-sun'; color = 'text-orange-500 bg-orange-50'; }
                if(shift.ShiftName.includes('‡∏î‡∏∂‡∏Å')) { icon = 'fa-moon'; color = 'text-purple-500 bg-purple-50'; }

                const shiftStartDateTime = new Date(`${shift.Nurse_Date}T${shift.StartTime}`);
                const isPast = new Date() > shiftStartDateTime;

                // ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô
                shiftsHtml += `
                    <div class="shift-card-large flex items-center gap-6 bg-white border border-slate-100 shadow-md mb-4">
                        <div class="w-20 h-20 rounded-3xl ${color} flex items-center justify-center text-4xl shadow-inner">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-1">${shift.ShiftName}</div>
                            <div class="time-display-large font-black text-slate-800">
                                ${shift.StartTime.slice(0,5)} - ${shift.EndTime.slice(0,5)}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            ${isPast ? 
                                `<span class="px-4 py-2 font-bold text-slate-400 bg-slate-100 rounded-xl text-sm text-center">‡∏à‡∏ö‡πÄ‡∏ß‡∏£</span>` : 
                                `<button onclick="clickRequestTrade('${shift.ScheduleID}')" class="action-btn-large font-bold text-indigo-600 bg-indigo-50 rounded-xl hover:bg-indigo-600 hover:text-white transition shadow-sm">‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£</button>
                                <button onclick="openSellModal('${shift.ScheduleID}', '${dateStr}', '${shift.ShiftName}')" class="action-btn-large font-bold text-emerald-600 bg-emerald-50 rounded-xl hover:bg-emerald-600 hover:text-white transition shadow-sm">‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ß‡∏£</button>`
                            }
                        </div>
                    </div>
                `;
            });

            content.innerHTML = `
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-black text-slate-800 mb-2">${dateStr}</h2>
                    <span class="px-4 py-1.5 bg-indigo-50 text-indigo-500 rounded-full text-sm font-bold tracking-wide uppercase">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</span>
                </div>
                <div class="max-h-[50vh] overflow-y-auto no-scrollbar px-2">
                    ${shiftsHtml}
                </div>
            `;
            
            backdrop.classList.remove('hidden');
            setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
            sheet.classList.remove('translate-y-full');
        }

        function closeDetailSheet() {
            const backdrop = document.getElementById('detailSheetBackdrop');
            const sheet = document.getElementById('detailSheet');
            sheet.classList.add('translate-y-full'); backdrop.classList.add('opacity-0'); setTimeout(() => backdrop.classList.add('hidden'), 300);
        }

        // --- SELL SHIFT LOGIC (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö DB PostSell) ---
        function openSellModal(scheduleId, dateStr, shiftName) {
            closeDetailSheet();
            const modal = document.getElementById('sellShiftModal');
            const content = document.getElementById('sellModalContent');
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ scheduleId ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î confirm
            modal.setAttribute('data-schedule-id', scheduleId);

            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            document.getElementById('sellPrice').value = '500';
            document.getElementById('sellMessage').value = '';

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-90');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeSellModal() {
            const modal = document.getElementById('sellShiftModal');
            const content = document.getElementById('sellModalContent');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-90');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        async function confirmSell() {
            const modal = document.getElementById('sellShiftModal');
            const scheduleId = modal.getAttribute('data-schedule-id');
            const price = document.getElementById('sellPrice').value;
            const message = document.getElementById('sellMessage').value;
            const btn = document.getElementById('btn-confirm-sell');
            const token = localStorage.getItem('token'); 
            
            if(!price) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', 'warning');

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏¢‡πâ‡∏≥
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            btn.disabled = true;

            try {
                // ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà API ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
                const res = await fetch(`${API_BASE}/api/sell-shift`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // ‚úÖ ‡πÅ‡∏ô‡∏ö Token
                    },
                    body: JSON.stringify({
                        userId: currentUser.UserID, // ‡∏™‡πà‡∏á UserID
                        scheduleId: scheduleId,     // ‡∏™‡πà‡∏á ScheduleID
                        price: price,               // ‡∏™‡πà‡∏á Price
                        message: message            // ‡∏™‡πà‡∏á Message
                    })
                });

                if (res.status === 401) { window.location.href = 'login.html'; return; } // ‚úÖ 401 Check
                
                const data = await res.json();
                
                if(data.success) {
                    closeSellModal();
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á PostSell ‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        // üî¥üî¥üî¥ Redirect ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ß‡∏£ (‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) üî¥üî¥üî¥
                        window.location.href = 'trade_market.html';
                    });
                } else {
                    throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢');
                }

            } catch(e) {
                console.error(e);
                Swal.fire('Error', e.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- BRIDGE FUNCTION: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Detail Sheet ‡∏Å‡∏±‡∏ö Post Modal (‡πÅ‡∏•‡∏Å‡πÄ‡∏ß‡∏£) ---
        function clickRequestTrade(scheduleId) {
            closeDetailSheet(); 
            setTimeout(() => {
                openPostModal(scheduleId);
            }, 350); 
        }

        // ================= 5. POST MODAL LOGIC (Updated to Redirect) =================
        async function openPostModal(preSelectedId = null) {
            const modal = document.getElementById('postModal');
            const content = document.getElementById('postModalContent');
            const token = localStorage.getItem('token'); // ‚úÖ ‡∏î‡∏∂‡∏á Token

            document.getElementById('createPostForm').reset();
            
            modal.classList.remove('hidden');
            setTimeout(() => { 
                modal.classList.remove('opacity-0'); 
                content.classList.remove('scale-90'); 
                content.classList.add('scale-100'); 
            }, 10);

            const select = document.getElementById('post-my-shift');
            select.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
            
            try {
                const res = await fetch(`${API_BASE}/api/schedule/my-future-shifts/${currentUser.UserID}`, {
                    method: 'GET', // ‚úÖ ‡∏£‡∏∞‡∏ö‡∏∏ Method
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // ‚úÖ ‡πÅ‡∏ô‡∏ö Token
                    }
                });

                if (res.status === 401) { window.location.href = 'login.html'; return; } // ‚úÖ 401 Check

                const data = await res.json();
                
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡πà‡∏≠‡∏¢ --</option>';
                
                if(data.success && data.results.length > 0) {
                    data.results.forEach(s => {
                        select.insertAdjacentHTML('beforeend', `<option value="${s.ScheduleID}">${moment(s.Nurse_Date).format('D MMM')} - ${s.ShiftName}</option>`);
                    });

                    if (preSelectedId) {
                        select.value = preSelectedId;
                    }

                } else { 
                    select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</option>'; 
                }
            } catch(e) { 
                select.innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</option>'; 
            }
        }

        function closePostModal() {
            const modal = document.getElementById('postModal');
            const content = document.getElementById('postModalContent');
            modal.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-90');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function handleCreatePost(e) {
            e.preventDefault();
            const myShiftId = document.getElementById('post-my-shift').value;
            const datePicker = document.getElementById('post-desired-date');
            const desiredDate = datePicker ? datePicker.value : "";
            const note = document.getElementById('post-note').value;
            const token = localStorage.getItem('token'); // ‚úÖ ‡∏î‡∏∂‡∏á Token

            if(!myShiftId) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', 'warning');

            const btn = document.getElementById('btn-create-post');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå...'; btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/api/posts/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // ‚úÖ ‡πÅ‡∏ô‡∏ö Token
                    },
                    body: JSON.stringify({ userId: currentUser.UserID, scheduleId: myShiftId, desiredDate, note })
                });

                if (res.status === 401) { window.location.href = 'login.html'; return; } // ‚úÖ 401 Check

                const data = await res.json();
                if(data.success) {
                    closePostModal();
                    Swal.fire({ 
                        icon: 'success', 
                        title: '‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                        text: '‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 
                        confirmButtonColor: '#f97316', 
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = 'swap_request.html';
                    });
                } else { Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message, 'error'); }
            } catch (err) { Swal.fire('Error', 'Connection Error', 'error'); }
            finally { btn.innerHTML = '<i class="fas fa-paper-plane"></i> ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô'; btn.disabled = false; }
        }

        // --- UTILS ---
        function openSelectionModal() { document.getElementById('scheduleTypeModal').classList.remove('hidden'); setTimeout(() => { document.getElementById('scheduleTypeModal').classList.remove('opacity-0'); document.getElementById('typeModalContent').classList.add('scale-100'); }, 10); }
        function closeSelectionModal() { document.getElementById('scheduleTypeModal').classList.add('opacity-0'); setTimeout(() => document.getElementById('scheduleTypeModal').classList.add('hidden'), 300); }
        function selectScheduleType(type) { if(type === 'personal') { document.getElementById('scheduleTypeModal').classList.add('opacity-0'); setTimeout(() => document.getElementById('scheduleTypeModal').classList.add('hidden'), 300); } else if(type === 'full') window.location.href = 'fullschedule.html'; }
        
        function openDatePicker() { pickerYear = currentDate.getFullYear(); updatePickerYear(); document.getElementById('datePickerModal').classList.remove('hidden'); setTimeout(() => { document.getElementById('datePickerModal').classList.remove('opacity-0'); document.getElementById('datePickerContent').classList.add('scale-100'); }, 10); }
        function closeDatePicker() { document.getElementById('datePickerModal').classList.add('opacity-0'); setTimeout(() => document.getElementById('datePickerModal').classList.add('hidden'), 300); }
        function adjustPickerYear(d) { pickerYear+=d; updatePickerYear(); }
        function updatePickerYear() { document.getElementById('pickerYearDisplay').innerText = pickerYear+543; }
        
        function generatePickerMonths() {
            document.querySelector('#datePickerModal .grid').innerHTML = THAI_MONTHS_SHORT.map((m,i) => `<button onclick="selectMonth(${i})" class="py-3 rounded-2xl bg-white border border-white shadow-sm text-slate-600 font-bold hover:bg-indigo-600 hover:text-white transition hover:shadow-lg">${m}</button>`).join('');
        }
        function selectMonth(i) { currentDate.setFullYear(pickerYear); currentDate.setMonth(i); closeDatePicker(); renderHeader(); loadSchedule(); }
        function changeMonth(d) { currentDate.setMonth(currentDate.getMonth()+d); renderHeader(); loadSchedule(); }
    </script>
</body>
</html>