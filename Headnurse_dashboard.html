<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Head Nurse Dashboard</title>
    
    <link href="css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="lib/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="lib/flatpickr.css">
    
    <script src="lib/flatpickr.js"></script>
    <script src="lib/th.js"></script>
    <script src="components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .flatpickr-calendar { font-family: 'Kanit', sans-serif !important; border: none !important; border-radius: 16px !important; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1) !important; padding: 10px !important; width: 320px !important; }
        .flatpickr-input[readonly] {cursor: pointer;}
        .flatpickr-day.selected { background: #7c3aed !important; border-color: #7c3aed !important; }
        .validation-box { background: #f9fafb; border-radius: 12px; padding: 12px 16px; margin-top: 8px; border: 1px solid #e5e7eb; }
        .validation-box ul { list-style: none; padding: 0; margin: 0; }
        .validation-box li { font-size: 0.8rem; margin-bottom: 4px; color: #9ca3af; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; }
        .validation-box li.valid { color: #10b981; font-weight: 500; }
        input.mismatch { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        input.valid-pass { border-color: #10b981 !important; background-color: #f0fdf4 !important; }
        input.invalid-pass { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .approval-section { background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); color: white; border-radius: 24px; }
        /* สไตล์ปุ่มบันทึกเมื่อกดใช้งานไม่ได้ */
        button#btn-save-settings:disabled {
            /* คงสีเดิมไว้ (ม่วง Gradient) */
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%) !important; 
            color: white !important;
            
            /* คงความมนสวยงามเหมือนเดิม */
            border-radius: 12px !important; 
            border: none !important;
            
            /* ทำให้ดูแตกต่างเล็กน้อยเพื่อให้รู้ว่า 'ทำงานเสร็จแล้ว' */
            opacity: 0.85; 
            
            /* สำคัญ: ทำให้กดปุ่มไม่ได้และไม่แสดงเมาส์รูปห้ามที่ดูแข็งกระด้าง */
            pointer-events: none; 
            cursor: default;
            box-shadow: none !important;
        }
        /* 1. บังคับให้เฉพาะช่อง Input ขยายเต็มพื้นที่ */
        #date-container {
            width: 100% !important;
        }

        /* 2. บังคับให้ Input ที่ Flatpickr สร้างขึ้นมา (altInput) กว้างเท่าช่องด้านบน */
        .flatpickr-input[readonly] {
            width: 100% !important;
        }

        /* 3. ล็อกขนาด "ตัวปฏิทิน" ที่เด้งลงมา ให้มีขนาดปกติ (ตามรูปภาพที่คุณส่งมา) */
        .flatpickr-calendar {
            width: 320px !important; /* ขนาดมาตรฐานที่ดูสวย */
            min-width: 320px !important;
        }
        /* จัดตำแหน่งไอคอนดวงตาใน Swal */
        .swal-input-container {
            position: relative;
            width: 100%;
        }
        .swal-eye-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #ccc;
            transition: color 0.3s;
            z-index: 10;
        }
        .swal-eye-icon:hover {
            color: #191970;
        }
        /* สถานะเงื่อนไขที่ผ่านแล้ว */
        .req-valid {
            color: #10b981 !important; /* สีเขียว */
            font-weight: 500;
        }
        .req-valid i {
            color: #10b981 !important;
        }

        /* ช่อง Input เมื่อรหัสผ่านตรงกัน */
        .input-match {
            border-color: #10b981 !important;
            background-color: #f0fdf4 !important;
        }
        /* สถานะเงื่อนไขรหัสผ่านใน Modal */
        .m-req-item { display: flex; align-items: center; gap: 8px; color: #888; transition: all 0.3s; font-size: 0.85rem; margin-bottom: 4px; }
        .m-req-item i { font-size: 0.75rem; }
        .m-req-item.valid { color: #28a745; font-weight: 500; }
        .m-req-item.valid i { color: #28a745; }

        /* สีของข้อความแจ้งเตือน Match */
        .m-text-success { color: #28a745; font-size: 0.8rem; }
        .m-text-danger { color: #dc3545; font-size: 0.8rem; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">
    <div id="toast-container" class="fixed top-4 right-4 z-[10000] flex flex-col gap-2 pointer-events-none"></div>

    <app-header></app-header>
    
    <main class="flex-1 overflow-y-auto bg-[#f8f9fa] pb-32">
        <div class="max-w-screen-md mx-auto p-4 space-y-6">

            <div class="approval-section p-6 shadow-xl shadow-indigo-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 backdrop-blur-3xl"></div>
                <div class="relative z-10">
                    <h3 class="text-lg font-bold flex items-center gap-2 mb-4">
                        <i class="fas fa-check-double"></i> ศูนย์อนุมัติรายการ
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <a href="swap_request.html" class="bg-white/20 hover:bg-white/30 transition-all p-4 rounded-2xl flex flex-col items-center relative group">
                            <span id="pending-swap-count" class="text-2xl font-black">0</span>
                            <span class="text-[10px] uppercase tracking-wider opacity-80">รออนุมัติแลกเวร</span>
                        </a>
                        <a href="trade_market.html" class="bg-white/20 hover:bg-white/30 transition-all p-4 rounded-2xl flex flex-col items-center relative group">
                            <span id="pending-trade-count" class="text-2xl font-black">0</span>
                            <span class="text-[10px] uppercase tracking-wider opacity-80">รออนุมัติซื้อขาย</span>
                        </a>
                    </div>
                </div>
            </div>

            <div class="modern-card p-6 relative">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-sliders-h text-violet-600"></i> ตั้งค่าระบบรับเวร
                        </h2>
                        <p class="text-xs text-gray-400 mt-1" id="period-status-text">กำลังตรวจสอบสถานะ...</p>
                    </div>
                    <div class="flex bg-gray-100 p-1 rounded-full">
                        <button onclick="togglePeriod('Open')" id="btn-open" class="toggle-btn toggle-inactive">OPEN</button>
                        <button onclick="togglePeriod('Closed')" id="btn-closed" class="toggle-btn toggle-inactive">CLOSED</button>
                    </div>
                </div>

                <form id="scheduleSettingsForm" class="space-y-6">
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-3 block text-center">จำนวนพยาบาลต่อเวร</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-2 font-medium"><i class="fas fa-sun text-amber-400 mr-1"></i>เช้า</div>
                                <input type="number" id="quotaMorning" class="stat-input w-full" placeholder="0" min="1" required>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-2 font-medium"><i class="fas fa-cloud-sun text-orange-400 mr-1"></i>บ่าย</div>
                                <input type="number" id="quotaAfternoon" class="stat-input w-full" placeholder="0" min="1" required>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-2 font-medium"><i class="fas fa-moon text-indigo-400 mr-1"></i>ดึก</div>
                                <input type="number" id="quotaNight" class="stat-input w-full" placeholder="0" min="1" required>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 block">วันปิดรับข้อมูล (DEADLINE)</label>
                        <div id="date-container" class="relative group w-full">
                            <input type="text" id="deadlineDate" placeholder="เลือกวันที่..." 
                                class="w-full bg-white border-2 border-gray-100 rounded-xl px-4 py-3 pl-11 text-sm font-medium text-gray-700 focus:border-violet-500 focus:ring-4 focus:ring-violet-50 transition outline-none cursor-pointer" 
                                required data-input>
                            <i class="fas fa-calendar-alt absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-hover:text-violet-500 transition-colors pointer-events-none"></i>
                        </div>
                    </div>

                    <button type="submit" id="btn-save-settings" class="btn-primary w-full flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> บันทึกการตั้งค่า
                    </button>
                </form>
            </div>

            <div class="modern-card p-6 border-l-4 border-amber-400">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="font-bold text-gray-800">ความคืบหน้าการส่งข้อจำกัด</h3>
                        <p class="text-xs text-gray-400 progress-text">กำลังโหลดข้อมูล...</p>
                    </div>
                    <div class="text-right">
                        <span id="submission-percent" class="progress-percent text-2xl font-black text-amber-500">0%</span>
                    </div>
                </div>
                <div class="w-full bg-gray-100 h-2.5 rounded-full overflow-hidden">
                    <div id="submission-bar" class="bg-amber-400 h-full transition-all duration-700" style="width: 0%"></div>
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">เมนูจัดการ</h3>
                
                <a href="constraint_settings.html" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-violet-200 transition-all duration-200">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-violet-50 rounded-full flex items-center justify-center text-violet-600"><i class="fas fa-user-clock text-lg"></i></div>
                        <div>
                            <div class="flex items-center gap-2">
                                <h4 class="text-sm font-bold text-gray-700">ส่งข้อจำกัด (ส่วนตัว)</h4>
                                <span id="my-constraint-status" class="px-2 py-1 rounded bg-gray-100 text-gray-400 text-xs font-bold">รอตรวจสอบ...</span>
                            </div>
                            <p class="text-[10px] text-gray-400">สำหรับหัวหน้าพยาบาล</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </a>

                <a href="nurse_list.html" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-users text-lg"></i></div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-700">รายชื่อพยาบาล</h4>
                            <p class="text-[10px] text-gray-400">จัดการข้อมูลบุคลากร</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </a>

                <a href="admin-import.html" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-file-excel text-lg"></i></div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-700">นำเข้าข้อมูล (Excel)</h4>
                            <p class="text-[10px] text-gray-400">อัปโหลดไฟล์รายชื่อพยาบาล</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </a>

                <div onclick="openPasswordModal()" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-amber-200 transition-all cursor-pointer">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-amber-50 rounded-full flex items-center justify-center text-amber-600"><i class="fas fa-key text-lg"></i></div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-700">เปลี่ยนรหัสผ่าน</h4>
                            <p class="text-[10px] text-gray-400">แก้ไขรหัสผ่านส่วนตัว</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            </div>

            <div id="generate-section" class="space-y-4">
                <a href="generate_schedule.html" id="btn-generate-real" class="hidden bg-gradient-to-r from-fuchsia-600 to-pink-600 text-white p-5 rounded-2xl shadow-lg flex items-center justify-between group">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-wand-magic-sparkles text-xl"></i></div>
                        <div><h4 class="font-bold text-lg">สร้างตารางเวร</h4><p class="text-xs text-fuchsia-100">ข้อมูลครบถ้วน พร้อมประมวลผล</p></div>
                    </div>
                    <i class="fas fa-arrow-right"></i>
                </a>
                
                <div id="btn-generate-locked" class="bg-white border-2 border-dashed border-gray-200 p-5 rounded-2xl flex items-center justify-between text-gray-400">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gray-50 rounded-full flex items-center justify-center"><i class="fas fa-lock"></i></div>
                        <div><h4 class="font-bold text-lg text-gray-500">ระบบยังไม่พร้อมจัดเวร</h4><p class="text-xs">รอปิดรับข้อมูล</p></div>
                    </div>
                </div>

                <a href="manage-schedule.html" class="flex items-center p-4 bg-white rounded-2xl shadow-sm border border-gray-100 hover:border-fuchsia-500 transition-all">
                    <div class="w-12 h-12 bg-fuchsia-100 text-fuchsia-600 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-edit text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800">จัดการตารางรายวัน</h3>
                        <p class="text-xs text-gray-400">แก้ไขหรือเติมพยาบาลในกะที่ว่าง</p>
                    </div>
                </a>
            </div>
        </div>
    </main>

    <app-navbar></app-navbar>

    <script>
    // ตรวจสอบ Base URL ของ API
    const API_URL = (typeof API_BASE !== 'undefined') ? API_BASE : 'https://autoshift-backend.onrender.com';
    
    // --- 1. เริ่มการทำงานเมื่อโหลดหน้าจอ ---
    document.addEventListener('DOMContentLoaded', () => {
        checkHeadNurseRole();
        setupCalendar();
        loadAllData();
        updateConstraintStatus();
        fetchPendingCounts();
        updateMyOwnConstraintStatus(); // ดึงสถานะของหัวหน้าเอง

        // ตั้งค่า Event Listener สำหรับฟอร์มบันทึก Quota
        const settingsForm = document.getElementById('scheduleSettingsForm');
        if(settingsForm) {
            settingsForm.addEventListener('submit', saveSettings);
        }
    });

    // --- 2. ฟังก์ชันหลัก (Core Functions) ---

    // ดึงข้อมูลการตั้งค่าและสถานะเปิด/ปิดระบบ
    async function loadAllData() {
        const token = localStorage.getItem('token');
        try {
            const [setRes, statRes] = await Promise.all([
                fetch(`${API_URL}/api/admin/get-settings`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`${API_URL}/api/check-constraint-window`, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);

            const settings = await setRes.json();
            const status = await statRes.json();

            // 1. นำค่าเดิมมาใส่ในช่อง Input
            if(settings.success && settings.settings) {
                document.getElementById('quotaMorning').value = settings.settings.morning || 0;
                document.getElementById('quotaAfternoon').value = settings.settings.afternoon || 0;
                document.getElementById('quotaNight').value = settings.settings.night || 0;
                
                if(settings.settings.deadline) {
                    document.getElementById('deadlineDate')._flatpickr.setDate(settings.settings.deadline);
                }
            }

            // 2. อัปเดต UI ส่วน Open/Closed
            updatePeriodUI(status.isOpen);

            // --- 3. จุดที่ต้องแก้: บังคับล็อคปุ่มทันทีที่โหลดเสร็จ ---
            const btnSave = document.getElementById('btn-save-settings');
            
            // เช็คว่าระบบเปิด (Open) อยู่หรือไม่ 
            // ถ้า status.isOpen เป็น true แสดงว่าบันทึกไปแล้ว ให้ล็อคปุ่มทันที
            if (status.isOpen === true) {
                btnSave.disabled = true;
                btnSave.innerHTML = '<i class="fas fa-check"></i> บันทึกสำเร็จแล้ว';
                btnSave.style.cursor = 'default';
                btnSave.style.pointerEvents = 'none';
            } else {
                // ถ้ายังไม่เปิด ให้ปุ่มกลับมาเป็นปกติ
                btnSave.disabled = false;
                btnSave.innerHTML = '<i class="fas fa-save"></i> บันทึกการตั้งค่า';
                btnSave.style.cursor = 'pointer';
                btnSave.style.pointerEvents = 'auto';
            }

        } catch(e) { 
            console.error("Load Data Error:", e); 
        }
    }
    // บันทึกการตั้งค่า Quota และ Deadline
    async function saveSettings(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-save-settings');
        const originalHTML = btn.innerHTML;

        // เริ่มต้นบันทึก: ปิดปุ่มชั่วคราวเพื่อกันการกดซ้ำระหว่างโหลด
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...';

        const payload = {
            morning: document.getElementById('quotaMorning').value,
            afternoon: document.getElementById('quotaAfternoon').value,
            night: document.getElementById('quotaNight').value,
            deadline: document.getElementById('deadlineDate').value
        };

        try {
            const token = localStorage.getItem('token');
            
            // 1. ส่งข้อมูลบันทึก Settings
            const res = await fetch(`${API_URL}/api/admin/save-settings`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.success) {
                // 2. สั่งเปิดระบบ (Open) ทันที
                await fetch(`${API_URL}/api/admin/toggle-window`, { 
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${token}`
                    }, 
                    body: JSON.stringify({ status: 'Open' }) 
                });

                // แสดงแจ้งเตือนสำเร็จ
                Swal.fire({ 
                    icon: 'success', 
                    title: 'สำเร็จ', 
                    text: 'บันทึกและเปิดระบบเรียบร้อยแล้ว', 
                    timer: 1500, 
                    showConfirmButton: false 
                });

                // 3. อัปเดต UI หน้าจอ (ปุ่ม Open จะติดสถานะทันที)
                loadAllData(); 
                
                // 4. บังคับปิดปุ่มถาวร
                btn.disabled = true; 
                btn.innerHTML = '<i class="fas fa-check"></i> บันทึกสำเร็จแล้ว';
                btn.style.cursor = 'default';
                btn.style.pointerEvents = 'none';

            } else {
                throw new Error(data.message || 'บันทึกไม่สำเร็จ');
            }
        } catch (err) {
            Swal.fire({ icon: 'error', title: 'ข้อผิดพลาด', text: err.message });
            // ถ้าเกิด Error ถึงจะยอมให้ปุ่มกลับมาเปิดเพื่อให้กดใหม่ได้
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
        // *** สังเกตว่าผมเอา btn.disabled = false ออกจากส่วนท้ายแล้ว เพื่อไม่ให้มันคืนค่าหลังทำงานเสร็จ ***
    }

    // เปิด/ปิด ระบบรับข้อมูล
    async function togglePeriod(status) {
        const action = status === 'Open' ? 'เปิด' : 'ปิด';
        const result = await Swal.fire({
            title: `ยืนยันการ ${action} ระบบ?`,
            text: status === 'Open' ? "พยาบาลจะสามารถเริ่มส่งข้อจำกัดได้" : "พยาบาลจะไม่สามารถส่งข้อมูลเพิ่มได้",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ยืนยัน',
            cancelButtonText: 'ยกเลิก'
        });

        if(!result.isConfirmed) return;

        try {
            const res = await fetch(`${API_URL}/api/admin/toggle-window`, { 
                method:'POST', 
                headers:{
                    'Content-Type':'application/json', 
                    'Authorization':`Bearer ${localStorage.getItem('token')}`
                }, 
                body:JSON.stringify({ status }) 
            });
            const data = await res.json();
            if(data.success) {
                loadAllData(); // โหลด UI ใหม่
            }
        } catch (e) { console.error(e); }
    }

    // --- 3. ฟังก์ชันดึงข้อมูลสถิติ (Statistics) ---

    // ดึงยอดรออนุมัติ Swap และ Trade
    async function fetchPendingCounts() {
        try {
            const res = await fetch(`${API_URL}/api/admin/pending-counts`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            const data = await res.json();
            if (data.success) {
                const s = document.getElementById('pending-swap-count');
                const t = document.getElementById('pending-trade-count');
                if(s) s.innerText = data.swapCount || 0;
                if(t) t.innerText = data.tradeCount || 0;
            }
        } catch (err) { console.error("Fetch Counts Error:", err); }
    }

    // ดึงความคืบหน้าการส่งข้อจำกัดของพยาบาลทุกคน
    async function updateConstraintStatus() {
        try {
            const res = await fetch(`${API_URL}/api/constraint-status`, { 
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } 
            });
            const data = await res.json();
            if (data.success) {
                const txt = document.querySelector('.progress-text');
                const pct = document.getElementById('submission-percent');
                const bar = document.getElementById('submission-bar');

                if(txt) txt.innerText = `ส่งแล้ว ${data.submitted} / ${data.total} คน`;
                const percent = Math.round((data.submitted / data.total) * 100) || 0;
                if(pct) pct.innerText = `${percent}%`;
                if(bar) bar.style.width = `${percent}%`;
            }
        } catch (err) { console.error(err); }
    }

    // ดึงสถานะส่วนตัวของหัวหน้าพยาบาล (ปุ่มสีเทา/เขียวในเมนูจัดการ)
    async function updateMyOwnConstraintStatus() {
        try {
            const res = await fetch(`${API_URL}/api/my-constraint-status`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            const data = await res.json();
            const statusEl = document.getElementById('my-constraint-status');
            if (statusEl && data.status) {
                statusEl.innerText = data.status;
                // เปลี่ยนสีตามสถานะ
                if(data.status === 'ส่งแล้ว') {
                    statusEl.classList.replace('bg-gray-100', 'bg-green-100');
                    statusEl.classList.replace('text-gray-400', 'text-green-600');
                }
            }
        } catch (err) { console.error(err); }
    }

    // --- 4. ฟังก์ชันช่วยเหลือ (Helpers) ---

    function updatePeriodUI(isOpen) {
        const btnOpen = document.getElementById('btn-open');
        const btnClosed = document.getElementById('btn-closed');
        const statusText = document.getElementById('period-status-text');

        if(btnOpen && btnClosed) {
            btnOpen.className = isOpen ? 'toggle-btn toggle-active-open' : 'toggle-btn toggle-inactive';
            btnClosed.className = !isOpen ? 'toggle-btn toggle-active-closed' : 'toggle-btn toggle-inactive';
        }
        
        if(statusText) {
            statusText.innerText = isOpen ? "ขณะนี้ระบบเปิดรับข้อจำกัด" : "ระบบปิดรับข้อจำกัดแล้ว";
        }

        const btnReal = document.getElementById('btn-generate-real');
        const btnLock = document.getElementById('btn-generate-locked');
        if (btnReal && btnLock) {
            btnReal.classList.toggle('hidden', isOpen);
            btnLock.classList.toggle('hidden', !isOpen);
        }
    }

    function setupCalendar() {
        flatpickr("#deadlineDate", { 
            locale: "th", 
            dateFormat: "Y-m-d", 
            altInput: true, 
            altFormat: "j F Y", 
            disableMobile: true,
            // เอา static: true ออก เพื่อไม่ให้ปฏิทินขยายตามความยาวช่อง Input
            static: false, 
            // ให้ปฏิทินแสดงผลโดยอิงจากตำแหน่งของ Input ปกติ
            position: "auto" 
        });
    }
    async function openPasswordModal() {
        await Swal.fire({
            title: '<h2 style="color: #191970; font-family: \'Kanit\'; font-weight: 700; font-size: 1.5rem;"><i class="fas fa-key"></i> ตั้งรหัสผ่านใหม่</h2>',
            html: `
                <div style="font-family: 'Kanit', sans-serif; text-align: center;">
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">กรุณาตั้งรหัสผ่านใหม่ตามเงื่อนไขความปลอดภัย</p>
                    
                    <div class="input-group" style="position: relative; margin-bottom: 1rem;">
                        <i class="fas fa-lock" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #888;"></i>
                        <input type="password" id="m-oldPassword" placeholder="รหัสผ่านปัจจุบัน" 
                            style="width: 100%; padding: 12px 40px; border: 2px solid #eee; border-radius: 50px; outline: none;">
                        <i class="fas fa-eye" onclick="toggleSwalPass('m-oldPassword', this)" 
                            style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #aaa; cursor: pointer;"></i>
                    </div>

                    <div class="input-group" style="position: relative; margin-bottom: 1rem;">
                        <i class="fas fa-shield-alt" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #888;"></i>
                        <input type="password" id="m-newPassword" placeholder="รหัสผ่านใหม่" 
                            style="width: 100%; padding: 12px 40px; border: 2px solid #eee; border-radius: 50px; outline: none;">
                        <i class="fas fa-eye" onclick="toggleSwalPass('m-newPassword', this)" 
                            style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #aaa; cursor: pointer;"></i>
                    </div>

                    <div style="text-align: left; background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 1rem; border: 1px solid #e9ecef;">
                        <p style="font-weight: bold; font-size: 0.85rem; margin-bottom: 5px; color: #444;">เงื่อนไขรหัสผ่าน:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li id="m-len" class="m-req-item"><i class="fas fa-circle"></i> 8 ตัวอักษรขึ้นไป</li>
                            <li id="m-up" class="m-req-item"><i class="fas fa-circle"></i> ตัวพิมพ์ใหญ่ (A-Z)</li>
                            <li id="m-lo" class="m-req-item"><i class="fas fa-circle"></i> ตัวพิมพ์เล็ก (a-z)</li>
                            <li id="m-num" class="m-req-item"><i class="fas fa-circle"></i> ตัวเลข (0-9)</li>
                            <li id="m-spc" class="m-req-item"><i class="fas fa-circle"></i> อักขระพิเศษ (!@#$.%)</li>
                        </ul>
                    </div>

                    <div class="input-group" style="position: relative; margin-bottom: 5px;">
                        <i class="fas fa-check-circle" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #888;"></i>
                        <input type="password" id="m-confirmPassword" placeholder="ยืนยันรหัสผ่านใหม่" 
                            style="width: 100%; padding: 12px 40px; border: 2px solid #eee; border-radius: 50px; outline: none;">
                        <i class="fas fa-eye" onclick="toggleSwalPass('m-confirmPassword', this)" 
                            style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #aaa; cursor: pointer;"></i>
                    </div>
                    <div id="m-matchMsg" style="text-align: left; margin-left: 15px; height: 20px; margin-bottom: 10px;"></div>
                </div>
            `,
            didOpen: () => {
                const oldInp = document.getElementById('m-oldPassword');
                const newInp = document.getElementById('m-newPassword');
                const confInp = document.getElementById('m-confirmPassword');
                const msgBox = document.getElementById('m-matchMsg');

                // ฟังก์ชัน Toggle ตา
                window.toggleSwalPass = (id, icon) => {
                    const input = document.getElementById(id);
                    const isPass = input.type === 'password';
                    input.type = isPass ? 'text' : 'password';
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                };

                // Logic ตรวจสอบ Real-time (ยกมาจากหน้าที่คุณส่งมา)
                const validate = () => {
                    const val = newInp.value;
                    const checks = {
                        len: val.length >= 8,
                        up: /[A-Z]/.test(val),
                        lo: /[a-z]/.test(val),
                        num: /[0-9]/.test(val),
                        spc: /[!@#\$%\^&\*\.]/.test(val)
                    };

                    const updateItem = (id, isValid) => {
                        const el = document.getElementById(id);
                        const icon = el.querySelector('i');
                        if (isValid) {
                            el.classList.add('valid');
                            icon.className = 'fas fa-check-circle';
                        } else {
                            el.classList.remove('valid');
                            icon.className = 'fas fa-circle';
                        }
                    };

                    updateItem('m-len', checks.len);
                    updateItem('m-up', checks.up);
                    updateItem('m-lo', checks.lo);
                    updateItem('m-num', checks.num);
                    updateItem('m-spc', checks.spc);

                    // เช็ค Match
                    const conf = confInp.value;
                    if (conf === "") {
                        msgBox.innerHTML = "";
                        confInp.style.borderColor = "#eee";
                    } else if (val === conf) {
                        msgBox.innerHTML = '<span class="m-text-success"><i class="fas fa-check"></i> รหัสผ่านตรงกัน</span>';
                        confInp.style.borderColor = "#28a745";
                    } else {
                        msgBox.innerHTML = '<span class="m-text-danger"><i class="fas fa-times"></i> รหัสผ่านไม่ตรงกัน</span>';
                        confInp.style.borderColor = "#dc3545";
                    }
                };

                newInp.addEventListener('input', validate);
                confInp.addEventListener('input', validate);
            },
            showCancelButton: true,
            confirmButtonText: 'ยืนยันการเปลี่ยนรหัส',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#191970',
            preConfirm: () => {
                const oldPass = document.getElementById('m-oldPassword').value;
                const newPass = document.getElementById('m-newPassword').value;
                const confirmPass = document.getElementById('m-confirmPassword').value;

                // ตรวจสอบเงื่อนไขทั้งหมด
                const isStrong = newPass.length >= 8 && /[A-Z]/.test(newPass) && /[a-z]/.test(newPass) && /[0-9]/.test(newPass) && /[!@#\$%\^&\*\.]/.test(newPass);

                if (!oldPass || !newPass || !confirmPass) return Swal.showValidationMessage('กรุณากรอกข้อมูลให้ครบถ้วน');
                if (newPass === oldPass) return Swal.showValidationMessage('รหัสผ่านใหม่ต้องไม่ซ้ำกับของเดิม');
                if (!isStrong) return Swal.showValidationMessage('รหัสผ่านยังไม่ผ่านเงื่อนไขความปลอดภัย');
                if (newPass !== confirmPass) return Swal.showValidationMessage('การยืนยันรหัสผ่านไม่ตรงกัน');

                return { oldPassword: oldPass, newPassword: newPass };
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                savePasswordToDB(result.value);
            }
        });
    }

    async function savePasswordToDB(payload) {
        // 1. แสดงสถานะกำลังโหลด
        Swal.fire({
            title: 'กำลังตรวจสอบข้อมูล...',
            html: 'กรุณารอสักครู่ ระบบกำลังบันทึกรหัสผ่านใหม่',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        try {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/api/change-password`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (data.success) {
                // ✅ 2. แจ้งเตือนเมื่อสำเร็จ
                await Swal.fire({
                    icon: 'success',
                    title: 'เปลี่ยนรหัสผ่านสำเร็จ!',
                    text: 'รหัสผ่านของคุณถูกอัปเดตเรียบร้อยแล้ว',
                    confirmButtonColor: '#191970',
                    confirmButtonText: 'ตกลง',
                    timer: 2500, // ปิดเองใน 2.5 วินาที
                    timerProgressBar: true
                });

                // (ทางเลือก) แนะนำให้สั่ง Logout หรือ Redirect ไปหน้า Login ใหม่เพื่อความปลอดภัย
                // window.location.href = 'login.html'; 

            } else {
                // ❌ 3. แจ้งเตือนเมื่อข้อมูลไม่ถูกต้อง (เช่น รหัสเดิมผิด)
                throw new Error(data.message || 'รหัสผ่านเดิมไม่ถูกต้อง กรุณาลองใหม่');
            }
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'การเปลี่ยนรหัสผ่านล้มเหลว',
                text: err.message,
                confirmButtonColor: '#dc3545'
            });
        }
    }
    // เพิ่มฟังก์ชันนี้ลงไปท้ายไฟล์ เพื่อตรวจสอบ RoleID
    function checkHeadNurseRole() {
        const user = JSON.parse(localStorage.getItem('user'));
        // เช็คว่าถ้าไม่มีข้อมูล user ในเครื่อง หรือ RoleID ไม่ใช่ 1 (หัวหน้าพยาบาล) ให้เด้งไปหน้า login
        if (!user || user.RoleID !== 1) {
            window.location.href = 'login.html';
        }
    }
</script>
</body>
</html>