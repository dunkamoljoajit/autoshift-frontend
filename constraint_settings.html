<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTONURSESHIFT - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏£</title>
    
    <link href="./style.css" rel="stylesheet"> 
    <link rel="stylesheet" href="lib/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="lib/flatpickr.css">
    
    <script src="lib/sweetalert2.js"></script>
    <script src="lib/moment.js"></script> 
    <script src="lib/flatpickr.js"></script>
    <script src="lib/th.js"></script> 
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="components.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof moment !== 'undefined') moment.locale('th');
            if (typeof flatpickr !== 'undefined' && flatpickr.l10ns.th) flatpickr.localize(flatpickr.l10ns.th);
        });
    </script>
</head>
<body class="bg-gray-50 font-sans">
    
    <app-header></app-header>

    <div class="max-w-screen-md mx-auto px-4 md:px-6 pt-24 pb-32 space-y-8">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-indigo-700">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏£</h1>
            <p class="text-slate-500 mt-2">‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
        </header>

        <div id="loading-overlay" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center hidden">
            <div class="text-center">
                <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-600 mb-3"></i>
                <p class="text-indigo-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤...</p>
            </div>
        </div>

        <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">üìÖ ‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h2>
            <div class="space-y-4">
                
                <p class="text-sm text-indigo-600 bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                    <i class="fas fa-info-circle mr-2"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£ **‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ**
                </p>

                <div>
                    <label class="text-sm font-medium text-slate-600 block mb-2">‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:</label>
                    <p id="setting-period-display" class="font-bold text-lg text-indigo-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≠‡∏ö...</p>
                </div>

                <hr class="border-slate-100">
                
                <div>
                    <label for="desired-days-off" class="text-sm font-medium text-slate-600 block mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î (Days Off)</label>
                    <div class="flex items-center gap-3">
                        <input type="number" id="desired-days-off" value="4" min="0" max="10" class="w-20 border-2 border-gray-100 rounded-xl p-3 text-sm text-center font-bold focus:border-indigo-500 transition outline-none">
                        <span class="text-slate-500">‡∏ß‡∏±‡∏ô/‡∏£‡∏≠‡∏ö</span>
                    </div>
                    <p class="text-xs text-slate-400 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ß‡∏±‡∏ô)</p>
                </div>

                <hr class="border-slate-100">

                <div>
                    <label class="text-sm font-medium text-slate-600 block mb-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å (‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£)</label>
                    <div class="flex gap-2">
                        <div class="flex-grow">
                            <app-date-picker 
                                placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô" 
                                input-id="fixed-days-off-picker"
                                data-mode="multiple"
                            ></app-date-picker>
                        </div>
                        <button type="button" id="clear-calendar-btn" class="px-3 py-3 bg-slate-100 text-slate-500 rounded-xl hover:bg-red-50 hover:text-red-500 transition border border-slate-200">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <p class="text-xs text-slate-400 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô)</p>
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">‚≠ê ‡∏Å‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£/‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (Preference)</h2>
            <p class="text-sm text-slate-400 mb-4 border-b pb-3 border-slate-100">
                ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏∞ (1: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏•‡∏¢, 5: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
            </p>
            <div class="grid grid-cols-3 gap-4">
                <div id="pref-Morning-input"></div>
                <div id="pref-Afternoon-input"></div>
                <div id="pref-Night-input"></div>
            </div>
        </section>

        <footer class="pt-4 pb-8">
            <button id="save-constraints-btn" class="w-full bg-indigo-600 text-white text-lg font-semibold py-3 rounded-2xl shadow-lg shadow-indigo-300 hover:bg-indigo-700 transition-all duration-300 transform active:scale-95">
                <i class="fas fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
            </button>
        </footer>

    </div>

    <app-navbar></app-navbar>

<script>
    const API_URL = (typeof API_BASE !== 'undefined') ? API_BASE : 'https://autoshift-backend.onrender.com';

    function ShiftPreferenceInput(shiftId, label) {
        let colorClass = shiftId.includes('Morning') ? 'text-blue-600' : (shiftId.includes('Afternoon') ? 'text-orange-600' : 'text-purple-600');
        return `
            <div class="text-center p-3 rounded-xl border-2 border-slate-200 bg-white shadow-sm hover:border-indigo-400 transition">
                <p class="text-sm font-bold mb-2 ${colorClass}">${label}</p>
                <input type="number" id="pref-${shiftId}" value="3" min="1" max="5" class="w-full border-2 border-gray-100 rounded-lg p-3 text-center text-xl font-bold focus:border-indigo-500 transition outline-none">
                <div class="mt-2 text-xs text-slate-400">‡∏£‡∏∞‡∏î‡∏±‡∏ö (1-5)</div>
            </div>
        `;
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || ![1, 2].includes(user.RoleID)) {
             window.location.href = 'login.html';
             return;
        }

        // 2. Render UI
        document.getElementById('pref-Morning-input').innerHTML = ShiftPreferenceInput('Morning', '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤');
        document.getElementById('pref-Afternoon-input').innerHTML = ShiftPreferenceInput('Afternoon', '‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢');
        document.getElementById('pref-Night-input').innerHTML = ShiftPreferenceInput('Night', '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å');
        
        // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Setting Period)
        const periodDisplay = document.getElementById('setting-period-display');
        let settingPeriodStart = '';
        if (typeof moment !== 'undefined') {
            const nextMonthStart = moment().add(1, 'month').startOf('month');
            const nextMonthEnd = moment().add(1, 'month').endOf('month');
            periodDisplay.innerText = `‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${nextMonthStart.format('D')} - ${nextMonthEnd.format('D MMMM YYYY')}`;
            settingPeriodStart = nextMonthStart.format('YYYY-MM-DD');
        }

        // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
        let fp; 
        setTimeout(() => {
            const limitInput = document.getElementById('desired-days-off');
            const pickerInput = document.getElementById('fixed-days-off-picker');
            const clearBtn = document.getElementById('clear-calendar-btn');

            if (pickerInput) {
                if (pickerInput._flatpickr) pickerInput._flatpickr.destroy();
                fp = flatpickr(pickerInput, {
                    mode: "multiple",
                    dateFormat: "Y-m-d",
                    altInput: true,
                    altFormat: "j F Y",
                    locale: "th",
                    conjunction: ", ",
                    onChange: function(selectedDates, dateStr, instance) {
                        const maxDays = parseInt(limitInput.value) || 0;
                        if (selectedDates.length > maxDays) {
                            const allowedDates = selectedDates.slice(0, maxDays);
                            instance.setDate(allowedDates, false);
                            Swal.fire({ toast: true, position: 'top-end', icon: 'warning', title: '‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤!', text: `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxDays} ‡∏ß‡∏±‡∏ô`, showConfirmButton: false, timer: 3000 });
                        }
                    }
                });

                limitInput.addEventListener('change', () => {
                    const maxDays = parseInt(limitInput.value) || 0;
                    if (fp.selectedDates.length > maxDays) {
                        const allowedDates = fp.selectedDates.slice(0, maxDays);
                        fp.setDate(allowedDates, false);
                    }
                });

                if (clearBtn) clearBtn.addEventListener('click', () => fp.clear());
            }
        }, 500);

        // ‚úÖ 5. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö (‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
        await checkSystemStatus();

        // ‚úÖ 6. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß)
        // ‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤
        setTimeout(() => {
            loadExistingData(settingPeriodStart);
        }, 800);

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢ ---

        async function checkSystemStatus() {
            try {
                const res = await fetch(`${API_URL}/api/check-constraint-window`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await res.json();
                
                // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö "‡∏õ‡∏¥‡∏î" (isOpen = false) -> ‡∏î‡∏µ‡∏î‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                if (!data.isOpen) {
                    Swal.fire({
                        icon: 'error',
                        title: '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß',
                        text: '‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ',
                        allowOutsideClick: false,
                        confirmButtonText: '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å'
                    }).then(() => {
                        window.location.href = user.RoleID === 1 ? 'Headnurse_dashboard.html' : 'dashboard.html';
                    });
                    // Disable ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß
                    document.getElementById('save-constraints-btn').disabled = true;
                    document.getElementById('save-constraints-btn').classList.add('bg-gray-400');
                }
            } catch (err) {
                console.error("Check Status Error", err);
            }
        }

        async function loadExistingData(period) {
            const loadingOverlay = document.getElementById('loading-overlay');
            const saveBtn = document.getElementById('save-constraints-btn');

            try {
                if (loadingOverlay) loadingOverlay.classList.remove('hidden'); 
                
                const res = await fetch(`${API_URL}/api/get-my-constraints?period=${period}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                if (!res.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                const response = await res.json();

                if (response.success && response.data) {
                    const d = response.data;
                    console.log("Found existing data:", d);

                    // 1. ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÉ‡∏™‡πà || '' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô undefined)
                    const fields = {
                        'desired-days-off': d.DaysOffMin,
                        'pref-Morning': d.PrefMorning,    // üí° ‡πÄ‡∏ä‡πá‡∏Ñ ID ‡πÉ‡∏ô HTML ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                        'pref-Afternoon': d.PrefAfternoon,
                        'pref-Night': d.PrefNight
                    };

                    for (const [id, value] of Object.entries(fields)) {
                        const el = document.getElementById(id);
                        if (el && value !== undefined) el.value = value;
                    }

                    // 2. ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô Flatpickr
                    if (d.FixedDaysOff) {
                        try {
                            let dates = [];
                            if (Array.isArray(d.FixedDaysOff)) {
                                dates = d.FixedDaysOff;
                            } else if (typeof d.FixedDaysOff === 'string') {
                                const trimmed = d.FixedDaysOff.trim();
                                if (trimmed.startsWith('[')) {
                                    dates = JSON.parse(trimmed);
                                } else if (trimmed.length > 0) {
                                    dates = trimmed.split(',').map(s => s.trim());
                                }
                            }

                            const pickerEl = document.getElementById('fixed-days-off-picker');
                            const picker = pickerEl ? pickerEl._flatpickr : null;
                            if (picker) {
                                picker.setDate(dates, true); // true ‡πÄ‡∏û‡∏∑‡πà‡∏≠ trigger change event
                            }
                        } catch (e) { 
                            console.error("Date processing error:", e); 
                        }
                    }

                    // 3. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° (Update UI)
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-edit mr-2"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°';
                        saveBtn.classList.replace('bg-indigo-600', 'bg-emerald-600');
                        saveBtn.classList.add('hover:bg-emerald-700');
                    }
                    
                    Swal.fire({
                        toast: true, position: 'top-end', icon: 'info', 
                        title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß', text: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 
                        timer: 2500, showConfirmButton: false
                    });
                }
            } catch (err) {
                console.error("Load Data Error:", err);
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
            } finally {
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
            }
        }

        // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Logic ‡πÄ‡∏î‡∏¥‡∏°)
        const saveBtn = document.getElementById('save-constraints-btn');
        saveBtn.addEventListener('click', async () => {
            const daysOff = parseInt(document.getElementById('desired-days-off').value) || 0;
            const fixedDaysOffString = document.getElementById('fixed-days-off-picker').value;
            
            const preferences = {
                Morning: parseInt(document.getElementById('pref-Morning').value) || 3,
                Afternoon: parseInt(document.getElementById('pref-Afternoon').value) || 3,
                Night: parseInt(document.getElementById('pref-Night').value) || 3,
            };

            if (daysOff < 0 || daysOff > 10) {
                  Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-10 ‡∏ß‡∏±‡∏ô', 'warning');
                  return;
            }
            
            const payload = {
                userId: user.UserID,
                settingPeriod: settingPeriodStart,
                daysOffMinimum: daysOff,
                fixedDaysOff: fixedDaysOffString ? fixedDaysOffString.split(',').map(d => d.trim()).filter(d => d) : [], 
                preferences: preferences,
                reason: "User Preference"
            };

            try {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                saveBtn.disabled = true;

                const res = await fetch(`${API_URL}/api/set-constraints`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                
                if (res.ok && result.success) {
                    Swal.fire({
                        title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', icon: 'success', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    }).then(() => {
                        window.location.href = user.RoleID === 1 ? 'Headnurse_dashboard.html' : 'dashboard.html';
                    });
                } else {
                    throw new Error(result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', e.message, 'error');
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î';
                saveBtn.disabled = false;
            }
        });
    });
</script>
</body>
</html>